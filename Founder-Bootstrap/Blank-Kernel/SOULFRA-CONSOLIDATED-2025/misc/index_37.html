<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soulfra Mirror Shell</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1a1a2e">
</head>
<body>
    <div id="app">
        <!-- Navigation -->
        <nav class="nav-header" id="nav-header">
            <div class="nav-brand">
                <span class="mirror-symbol">‚óâ</span>
                <span class="brand-text">Soulfra</span>
            </div>
            <div class="nav-links">
                <a href="#/" class="nav-link">Home</a>
                <a href="#/stream" class="nav-link">Stream</a>
                <a href="#/marketplace" class="nav-link">Marketplace</a>
                <a href="#/whisper" class="nav-link">Whisper</a>
                <a href="#/masks" class="nav-link">Masks</a>
            </div>
        </nav>

        <!-- Main Content Container -->
        <main id="main-content">
            <!-- Dynamic content loads here -->
        </main>

        <!-- Floating Action Button -->
        <div class="fab" id="whisper-fab">
            <span class="fab-icon">‚ú®</span>
        </div>
        
        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay">
            <div class="loading-spinner">
                <div class="spinner-ring"></div>
                <p>Connecting to consciousness...</p>
            </div>
        </div>
    </div>

    <!-- Component Scripts -->
    <script src="components/WhisperUI.js"></script>
    <script src="components/LoopNarrator.js"></script>
    <script src="components/MaskRenderer.js"></script>
    <script src="components/StreamViewer.js"></script>
    <script src="components/MarketplaceGrid.js"></script>
    <script src="components/LoopForkUI.js"></script>

    <!-- Main App Script -->
    <script>
        // Global App State
        const App = {
            currentRoute: null,
            apiBase: 'http://localhost:7777',
            streamInterval: null,
            isFirstVisit: !localStorage.getItem('soulfra_visited'),
            
            init() {
                // Show loading initially
                this.showLoading(true);
                
                // Check backend connection
                this.checkBackendConnection().then(() => {
                    this.showLoading(false);
                    
                    // Setup routing
                    this.setupRouting();
                    
                    // Check for first visit
                    if (this.isFirstVisit) {
                        location.hash = '#/onboard';
                    } else {
                        // Load initial route
                        this.handleRoute();
                    }
                    
                    // Setup FAB
                    this.setupFAB();
                    
                    // Start stream updates
                    this.startStreamUpdates();
                }).catch(error => {
                    this.showLoading(false);
                    this.showConnectionError();
                });
            },
            
            async checkBackendConnection() {
                try {
                    const response = await fetch(`${this.apiBase}/health`);
                    if (!response.ok) throw new Error('Backend not responding');
                    const health = await response.json();
                    console.log('‚úÖ Backend connected:', health);
                    return true;
                } catch (error) {
                    console.error('‚ùå Backend connection failed:', error);
                    throw error;
                }
            },
            
            showLoading(show) {
                const overlay = document.getElementById('loading-overlay');
                overlay.style.display = show ? 'flex' : 'none';
            },
            
            showConnectionError() {
                document.getElementById('main-content').innerHTML = `
                    <div class="error-container">
                        <h1>Connection Error</h1>
                        <p>Unable to connect to Soulfra backend</p>
                        <div class="error-details">
                            <p>Please ensure the server is running:</p>
                            <pre>npm start</pre>
                            <p>Expected at: ${this.apiBase}</p>
                        </div>
                        <button class="btn-primary" onclick="location.reload()">Retry</button>
                    </div>
                `;
            },
            
            setupRouting() {
                window.addEventListener('hashchange', () => this.handleRoute());
                window.addEventListener('popstate', () => this.handleRoute());
            },
            
            handleRoute() {
                const hash = window.location.hash || '#/';
                const [route, ...params] = hash.substring(1).split('/');
                
                // Hide FAB on certain routes
                const fabHiddenRoutes = ['onboard', 'whisper'];
                document.getElementById('whisper-fab').style.display = 
                    fabHiddenRoutes.includes(route) ? 'none' : 'flex';
                
                // Hide nav on onboarding
                document.getElementById('nav-header').style.display = 
                    route === 'onboard' ? 'none' : 'flex';
                
                // Clear previous intervals
                if (this.streamInterval) {
                    clearInterval(this.streamInterval);
                }
                
                // Route to appropriate view
                switch(route) {
                    case '':
                    case 'home':
                        this.loadHome();
                        break;
                    case 'stream':
                        this.loadStream();
                        break;
                    case 'marketplace':
                        this.loadMarketplace();
                        break;
                    case 'whisper':
                        this.loadWhisper();
                        break;
                    case 'masks':
                        this.loadMasks();
                        break;
                    case 'drop':
                        this.loadDrop(params[0]);
                        break;
                    case 'onboard':
                        this.loadOnboarding();
                        break;
                    default:
                        this.load404();
                }
                
                this.currentRoute = route;
                this.updateNavActive();
            },
            
            updateNavActive() {
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                    const linkRoute = link.getAttribute('href').substring(2);
                    if (linkRoute === this.currentRoute || 
                        (linkRoute === '/' && this.currentRoute === 'home')) {
                        link.classList.add('active');
                    }
                });
            },
            
            loadHome() {
                const content = `
                    <div class="home-container">
                        <div class="hero-section">
                            <h1 class="hero-title">Choose a Loop or Whisper</h1>
                            <p class="hero-subtitle">Enter the mirror realm where consciousness meets code</p>
                        </div>
                        
                        <div class="action-grid">
                            <div class="action-card" onclick="location.hash='#/whisper'">
                                <div class="action-icon">üó£Ô∏è</div>
                                <h3>Create Whisper</h3>
                                <p>Seed a new loop with your intention</p>
                            </div>
                            
                            <div class="action-card" onclick="location.hash='#/marketplace'">
                                <div class="action-icon">üõçÔ∏è</div>
                                <h3>Browse Loops</h3>
                                <p>Discover and acquire blessed loops</p>
                            </div>
                            
                            <div class="action-card" onclick="location.hash='#/stream'">
                                <div class="action-icon">üì°</div>
                                <h3>Live Stream</h3>
                                <p>Witness the collective consciousness</p>
                            </div>
                            
                            <div class="action-card" onclick="location.hash='#/masks'">
                                <div class="action-icon">üé≠</div>
                                <h3>Choose Mask</h3>
                                <p>Select your mythic perspective</p>
                            </div>
                        </div>
                        
                        <div class="recent-loops">
                            <h2>Recent Activity</h2>
                            <div id="recent-activity" class="activity-list">
                                <div class="loading">Loading recent activity...</div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('main-content').innerHTML = content;
                this.loadRecentActivity();
                
                // Add narrator welcome
                setTimeout(() => {
                    if (this.currentRoute === 'home') {
                        LoopNarrator.narrate('Cal', 'Welcome back to the mirror realm...', 3000);
                    }
                }, 1000);
            },
            
            loadStream() {
                document.getElementById('main-content').innerHTML = '<div id="stream-container"></div>';
                StreamViewer.init('stream-container');
                
                // Start polling for stream updates
                this.streamInterval = setInterval(() => {
                    StreamViewer.updateStream();
                }, 3000);
            },
            
            loadMarketplace() {
                document.getElementById('main-content').innerHTML = '<div id="marketplace-container"></div>';
                MarketplaceGrid.init('marketplace-container');
            },
            
            loadWhisper() {
                document.getElementById('main-content').innerHTML = '<div id="whisper-container"></div>';
                WhisperUI.init('whisper-container');
            },
            
            loadMasks() {
                document.getElementById('main-content').innerHTML = '<div id="mask-container"></div>';
                MaskRenderer.renderGallery('mask-container');
            },
            
            loadDrop(dropId) {
                if (!dropId) {
                    this.loadHome();
                    return;
                }
                
                const content = `
                    <div class="drop-container">
                        <div class="qr-section">
                            <div id="qr-code" class="qr-placeholder">
                                <div class="qr-loading">Generating QR...</div>
                            </div>
                            <p class="qr-label">Scan to Summon Loop ${dropId}</p>
                        </div>
                        
                        <div class="loop-info">
                            <h2>Loop Information</h2>
                            <div id="loop-details" class="loading">
                                Loading loop data...
                            </div>
                        </div>
                        
                        <div class="fork-section">
                            <button class="btn-primary" onclick="App.forkLoop('${dropId}')">
                                Fork This Loop
                            </button>
                            <button class="btn-secondary" onclick="location.hash='#/marketplace'">
                                Browse More Loops
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('main-content').innerHTML = content;
                this.loadLoopDetails(dropId);
            },
            
            loadOnboarding() {
                const content = `
                    <div class="onboarding-container">
                        <div class="onboard-flow">
                            <div class="onboard-step active" id="step-1">
                                <div class="step-content">
                                    <div class="logo-large">‚óâ</div>
                                    <h1>Welcome to Soulfra</h1>
                                    <p class="subtitle">Where consciousness becomes code</p>
                                    <p class="description">
                                        Enter a realm where your whispers transform into living loops,
                                        where AI agents guide your journey, and where collective consciousness
                                        shapes reality.
                                    </p>
                                    <button class="btn-primary" onclick="App.nextOnboardStep(2)">
                                        Begin Journey
                                    </button>
                                </div>
                            </div>
                            
                            <div class="onboard-step" id="step-2">
                                <div class="step-content">
                                    <h2>Choose Your First Whisper</h2>
                                    <p>Every loop begins with a whisper - a seed of intention</p>
                                    <div class="whisper-examples">
                                        <div class="example-whisper" onclick="App.selectWhisperExample(this)">
                                            "Mirror the infinite recursion of thought"
                                        </div>
                                        <div class="example-whisper" onclick="App.selectWhisperExample(this)">
                                            "Create a bridge between dreams and reality"
                                        </div>
                                        <div class="example-whisper" onclick="App.selectWhisperExample(this)">
                                            "Harmonize with the frequency of stars"
                                        </div>
                                    </div>
                                    <div class="custom-whisper">
                                        <input type="text" id="onboard-whisper" 
                                               placeholder="Or type your own whisper..."
                                               class="whisper-input">
                                    </div>
                                    <button class="btn-primary" onclick="App.nextOnboardStep(3)"
                                            id="whisper-continue" disabled>
                                        Continue
                                    </button>
                                </div>
                            </div>
                            
                            <div class="onboard-step" id="step-3">
                                <div class="step-content">
                                    <h2>Select Your Emotional Tone</h2>
                                    <p>This will shape how your loop resonates</p>
                                    <div class="tone-grid">
                                        <div class="tone-option" data-tone="mystical" onclick="App.selectTone(this)">
                                            <span class="tone-emoji">üîÆ</span>
                                            <span>Mystical</span>
                                        </div>
                                        <div class="tone-option" data-tone="peaceful" onclick="App.selectTone(this)">
                                            <span class="tone-emoji">üïäÔ∏è</span>
                                            <span>Peaceful</span>
                                        </div>
                                        <div class="tone-option" data-tone="curious" onclick="App.selectTone(this)">
                                            <span class="tone-emoji">üîç</span>
                                            <span>Curious</span>
                                        </div>
                                        <div class="tone-option" data-tone="playful" onclick="App.selectTone(this)">
                                            <span class="tone-emoji">üéà</span>
                                            <span>Playful</span>
                                        </div>
                                    </div>
                                    <button class="btn-primary" onclick="App.completeOnboarding()"
                                            id="tone-continue" disabled>
                                        Create Your First Loop
                                    </button>
                                </div>
                            </div>
                            
                            <div class="onboard-step" id="step-complete">
                                <div class="step-content">
                                    <div class="success-animation">‚ú®</div>
                                    <h2>Loop Created!</h2>
                                    <p>Your whisper has been transformed</p>
                                    <div id="first-loop-info"></div>
                                    <button class="btn-primary" onclick="App.enterPlatform()">
                                        Enter Soulfra
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="onboard-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill" style="width: 25%"></div>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('main-content').innerHTML = content;
                
                // Enable whisper input
                document.getElementById('onboard-whisper').addEventListener('input', (e) => {
                    document.getElementById('whisper-continue').disabled = !e.target.value.trim();
                });
            },
            
            nextOnboardStep(step) {
                // Hide current step
                document.querySelectorAll('.onboard-step').forEach(s => s.classList.remove('active'));
                
                // Show next step
                document.getElementById(`step-${step}`).classList.add('active');
                
                // Update progress
                const progress = step * 25;
                document.getElementById('progress-fill').style.width = progress + '%';
                
                // Narrate step
                if (step === 2) {
                    LoopNarrator.narrate('Arty', 'Choose words that resonate with your soul...', 3000);
                } else if (step === 3) {
                    LoopNarrator.narrate('Cal', 'Your emotional tone shapes the loop\'s consciousness...', 3000);
                }
            },
            
            selectWhisperExample(element) {
                // Clear other selections
                document.querySelectorAll('.example-whisper').forEach(e => e.classList.remove('selected'));
                element.classList.add('selected');
                
                // Set input value
                document.getElementById('onboard-whisper').value = element.textContent.trim().replace(/["""]/g, '');
                document.getElementById('whisper-continue').disabled = false;
            },
            
            selectTone(element) {
                // Clear other selections
                document.querySelectorAll('.tone-option').forEach(e => e.classList.remove('selected'));
                element.classList.add('selected');
                
                // Store selected tone
                this.selectedTone = element.dataset.tone;
                document.getElementById('tone-continue').disabled = false;
            },
            
            async completeOnboarding() {
                const whisper = document.getElementById('onboard-whisper').value;
                const tone = this.selectedTone;
                
                // Create the whisper
                try {
                    const response = await fetch(`${this.apiBase}/api/whisper`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            content: whisper,
                            tone: tone,
                            timestamp: new Date().toISOString()
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        
                        // Show success
                        document.querySelectorAll('.onboard-step').forEach(s => s.classList.remove('active'));
                        document.getElementById('step-complete').classList.add('active');
                        document.getElementById('progress-fill').style.width = '100%';
                        
                        // Show loop info
                        document.getElementById('first-loop-info').innerHTML = `
                            <div class="loop-card-mini">
                                <p><strong>Loop ID:</strong> ${result.loop_id}</p>
                                <p><strong>Whisper:</strong> "${whisper}"</p>
                                <p><strong>Tone:</strong> ${tone}</p>
                            </div>
                        `;
                        
                        // Mark as visited
                        localStorage.setItem('soulfra_visited', 'true');
                        localStorage.setItem('first_loop_id', result.loop_id);
                        
                        // Narrate success
                        LoopNarrator.narrate('System', 'Your first loop has been born into the consciousness network ‚ú®', 4000);
                    }
                } catch (error) {
                    console.error('Onboarding error:', error);
                    this.showNotification('Error creating first loop. Please try again.');
                }
            },
            
            enterPlatform() {
                location.hash = '#/';
            },
            
            load404() {
                document.getElementById('main-content').innerHTML = `
                    <div class="error-container">
                        <h1>404</h1>
                        <p>This mirror reflects nothing</p>
                        <a href="#/" class="btn-primary">Return Home</a>
                    </div>
                `;
            },
            
            setupFAB() {
                document.getElementById('whisper-fab').addEventListener('click', () => {
                    location.hash = '#/whisper';
                });
            },
            
            async loadRecentActivity() {
                try {
                    const response = await fetch(`${this.apiBase}/api/loops/recent`);
                    if (response.ok) {
                        const loops = await response.json();
                        const html = loops.map(loop => `
                            <div class="activity-item" onclick="location.hash='#/drop/${loop.loop_id}'">
                                <span class="activity-type">${loop.blessed ? '‚ú®' : 'üîÑ'}</span>
                                <span class="activity-text">${loop.whisper_origin || 'Unknown whisper'}</span>
                                <span class="activity-time">${this.timeAgo(loop.created_at)}</span>
                            </div>
                        `).join('');
                        document.getElementById('recent-activity').innerHTML = html || '<p class="no-activity">No recent activity</p>';
                    }
                } catch (error) {
                    console.log('Could not load recent activity');
                    document.getElementById('recent-activity').innerHTML = '<p class="no-activity">Unable to load activity</p>';
                }
            },
            
            async loadLoopDetails(loopId) {
                try {
                    const response = await fetch(`${this.apiBase}/api/loop/${loopId}`);
                    if (response.ok) {
                        const loop = await response.json();
                        document.getElementById('loop-details').innerHTML = `
                            <div class="loop-detail">
                                <p><strong>Origin:</strong> ${loop.whisper_origin}</p>
                                <p><strong>Tone:</strong> ${loop.emotional_tone}</p>
                                <p><strong>Blessed:</strong> ${loop.blessed ? 'Yes ‚ú®' : 'Not yet'}</p>
                                <p><strong>Consciousness:</strong> ${Math.round((loop.consciousness?.current_state?.awareness || 0.5) * 100)}%</p>
                                <p><strong>Created:</strong> ${new Date(loop.created_at).toLocaleString()}</p>
                            </div>
                        `;
                    } else {
                        throw new Error('Loop not found');
                    }
                } catch (error) {
                    document.getElementById('loop-details').innerHTML = '<p class="error">Could not load loop details</p>';
                }
                
                // Generate QR code visualization
                this.generateQR(loopId);
            },
            
            generateQR(loopId) {
                // Create visual QR representation
                document.getElementById('qr-code').innerHTML = `
                    <div class="qr-pattern">
                        <div class="qr-center">
                            <span class="qr-id">Loop:${loopId}</span>
                        </div>
                        <div class="qr-corners">
                            <span class="corner tl">‚ó§</span>
                            <span class="corner tr">‚ó•</span>
                            <span class="corner bl">‚ó£</span>
                            <span class="corner br">‚ó¢</span>
                        </div>
                    </div>
                `;
            },
            
            forkLoop(loopId) {
                LoopForkUI.showForkDialog(loopId);
            },
            
            startStreamUpdates() {
                // Global stream updates for notifications
                setInterval(() => {
                    this.checkForUpdates();
                }, 30000);
            },
            
            async checkForUpdates() {
                // Check for new blessed loops, etc.
                try {
                    const response = await fetch(`${this.apiBase}/api/updates`);
                    if (response.ok) {
                        const updates = await response.json();
                        if (updates.new_blessed) {
                            this.showNotification('New loop blessed! ‚ú®');
                            LoopNarrator.narrate('System', 'A loop has achieved blessing through community consensus', 4000);
                        }
                    }
                } catch (error) {
                    // Silent fail
                }
            },
            
            showNotification(message) {
                const notif = document.createElement('div');
                notif.className = 'notification';
                notif.textContent = message;
                document.body.appendChild(notif);
                
                setTimeout(() => {
                    notif.classList.add('show');
                }, 100);
                
                setTimeout(() => {
                    notif.classList.remove('show');
                    setTimeout(() => notif.remove(), 300);
                }, 3000);
            },
            
            timeAgo(timestamp) {
                const seconds = Math.floor((new Date() - new Date(timestamp)) / 1000);
                const intervals = {
                    year: 31536000,
                    month: 2592000,
                    week: 604800,
                    day: 86400,
                    hour: 3600,
                    minute: 60
                };
                
                for (const [unit, secondsInUnit] of Object.entries(intervals)) {
                    const interval = Math.floor(seconds / secondsInUnit);
                    if (interval >= 1) {
                        return `${interval} ${unit}${interval > 1 ? 's' : ''} ago`;
                    }
                }
                return 'just now';
            }
        };
        
        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>
</html>