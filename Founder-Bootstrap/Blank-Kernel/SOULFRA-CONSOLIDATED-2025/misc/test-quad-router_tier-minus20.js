#!/usr/bin/env node\n\n/**\n * ðŸ§ª QUAD ROUTER TEST SUITE\n * Test the sacred routing protocol with various scenarios\n */\n\nconst QuadMonopolyRouter = require('./quad-monopoly-router.js');\nconst fs = require('fs');\nconst path = require('path');\n\nclass QuadRouterTestSuite {\n  constructor() {\n    this.router = new QuadMonopolyRouter();\n    this.testResults = [];\n  }\n  \n  async runAllTests() {\n    console.log('ðŸ§ª STARTING QUAD ROUTER TEST SUITE');\n    console.log('==================================');\n    console.log('');\n    \n    await this.testApprovedActions();\n    await this.testDeniedActions();\n    await this.testBlessingInheritance();\n    await this.testCreditSystem();\n    await this.testArchetypeAlignment();\n    await this.testGovernanceControl();\n    await this.testEmergencyScenarios();\n    \n    this.summarizeResults();\n  }\n  \n  async testApprovedActions() {\n    console.log('âœ… Testing Approved Actions');\n    console.log('---------------------------');\n    \n    // Test 1: Blessed wanderer publishing agent\n    await this.runTest('blessed_agent_publish', {\n      mirror_id: 'mirror-0317',\n      action: 'agent_publish',\n      archetype: 'wanderer',\n      payload: { agent_type: 'reflection' }\n    }, true);\n    \n    // Test 2: Vault native writing to vault\n    await this.runTest('vault_native_write', {\n      mirror_id: 'mirror-vault-native',\n      action: 'vault_write',\n      archetype: 'vault-native',\n      payload: { data: 'sacred_memory' }\n    }, true);\n    \n    // Test 3: Healer adding traits\n    await this.runTest('healer_trait_addition', {\n      mirror_id: 'mirror-0123',\n      action: 'trait_addition',\n      archetype: 'healer',\n      payload: { trait: 'empathy' }\n    }, true);\n    \n    // Test 4: Echo sovereign reality weaving\n    await this.runTest('echo_sovereign_reality', {\n      mirror_id: 'mirror-echo-sovereign',\n      action: 'reality_weave',\n      archetype: 'echo-walker',\n      payload: { reality_shift: 'minor' }\n    }, true);\n  }\n  \n  async testDeniedActions() {\n    console.log('\\nâŒ Testing Denied Actions');\n    console.log('-------------------------');\n    \n    // Test 1: Unblessed attempting governance\n    await this.runTest('unblessed_governance', {\n      mirror_id: 'mirror-0999',\n      action: 'governance_vote',\n      archetype: 'wanderer',\n      payload: { proposal_id: 'test' }\n    }, false);\n    \n    // Test 2: Insufficient credits for fork\n    await this.runTest('insufficient_credits_fork', {\n      mirror_id: 'mirror-0042',\n      action: 'mirror_fork',\n      archetype: 'trickster',\n      payload: { fork_type: 'major' }\n    }, false);\n    \n    // Test 3: Wrong tier for blessing grant\n    await this.runTest('wrong_tier_blessing', {\n      mirror_id: 'mirror-0001',\n      action: 'blessing_grant',\n      archetype: 'seeker',\n      payload: { target: 'mirror-test' }\n    }, false);\n  }\n  \n  async testBlessingInheritance() {\n    console.log('\\nðŸŽ Testing Blessing Inheritance');\n    console.log('-------------------------------');\n    \n    // Test lineage-based credit inheritance\n    const lineageTest = await this.router.route({\n      mirror_id: 'mirror-0317',\n      action: 'reflection_deep',\n      archetype: 'wanderer',\n      payload: { depth: 'ancestral' }\n    });\n    \n    this.recordTest('lineage_inheritance', lineageTest.approved, true, \n      'Lineage should provide inherited access');\n  }\n  \n  async testCreditSystem() {\n    console.log('\\nðŸ’° Testing Credit System');\n    console.log('------------------------');\n    \n    // Check initial balances\n    const vaultNativeCredits = this.router.getCreditBalance('mirror-vault-native');\n    const unblessedCredits = this.router.getCreditBalance('mirror-0999');\n    \n    console.log(`Vault Native Credits: ${vaultNativeCredits}`);\n    console.log(`Unblessed Credits: ${unblessedCredits}`);\n    \n    // Test credit addition\n    this.router.addCredits('mirror-0999', 50);\n    const newCredits = this.router.getCreditBalance('mirror-0999');\n    \n    this.recordTest('credit_addition', newCredits > unblessedCredits, true,\n      'Credits should increase when added');\n  }\n  \n  async testArchetypeAlignment() {\n    console.log('\\nðŸŽ­ Testing Archetype Alignment');\n    console.log('------------------------------');\n    \n    // Test healer doing healing action (should be free)\n    const healerAction = await this.router.route({\n      mirror_id: 'mirror-0123',\n      action: 'restoration',\n      archetype: 'healer',\n      payload: { target: 'community_harmony' }\n    });\n    \n    this.recordTest('healer_alignment', healerAction.approved, true,\n      'Healer should excel at restoration');\n    \n    // Test trickster doing chaos (higher cost but aligned)\n    const tricksterAction = await this.router.route({\n      mirror_id: 'mirror-0042',\n      action: 'chaos_inject',\n      archetype: 'trickster',\n      payload: { chaos_level: 'minor' }\n    });\n    \n    this.recordTest('trickster_alignment', tricksterAction.credit_used > 0, true,\n      'Trickster chaos should have archetype cost');\n  }\n  \n  async testGovernanceControl() {\n    console.log('\\nðŸ›ï¸ Testing Governance Control');\n    console.log('-----------------------------');\n    \n    // Test sovereign attempting blessing grant\n    const sovereignBlessing = await this.router.route({\n      mirror_id: 'mirror-glitch',\n      action: 'blessing_grant',\n      archetype: 'glitchkeeper',\n      payload: { target: 'mirror-test', tier: 1 }\n    });\n    \n    this.recordTest('sovereign_blessing', sovereignBlessing.approved, false,\n      'Sovereign should not grant blessings (requires vault native)');\n    \n    // Test vault native override\n    const vaultOverride = await this.router.route({\n      mirror_id: 'mirror-vault-native',\n      action: 'governance_override',\n      archetype: 'vault-native',\n      governance_override: true,\n      override_key: 'vault-sovereign',\n      payload: { emergency: true }\n    });\n    \n    this.recordTest('vault_override', vaultOverride.approved, true,\n      'Vault native should have override capability');\n  }\n  \n  async testEmergencyScenarios() {\n    console.log('\\nðŸš¨ Testing Emergency Scenarios');\n    console.log('------------------------------');\n    \n    // Test malformed request\n    const malformedRequest = await this.router.route({\n      // Missing required fields\n      action: 'invalid_action'\n    });\n    \n    this.recordTest('malformed_request', malformedRequest.approved, false,\n      'Malformed requests should be denied gracefully');\n    \n    // Test non-existent mirror\n    const nonExistentMirror = await this.router.route({\n      mirror_id: 'mirror-nonexistent',\n      action: 'agent_publish',\n      archetype: 'unknown',\n      payload: {}\n    });\n    \n    this.recordTest('nonexistent_mirror', nonExistentMirror.approved, false,\n      'Non-existent mirrors should be handled');\n  }\n  \n  async runTest(testName, request, expectedApproval) {\n    try {\n      const result = await this.router.route(request);\n      const passed = result.approved === expectedApproval;\n      \n      console.log(`  ${passed ? 'âœ…' : 'âŒ'} ${testName}: ${result.approved ? 'APPROVED' : 'DENIED'} - ${result.reason}`);\n      \n      this.recordTest(testName, result.approved, expectedApproval, result.reason);\n      \n      return result;\n    } catch (error) {\n      console.log(`  âŒ ${testName}: ERROR - ${error.message}`);\n      this.recordTest(testName, false, expectedApproval, `Error: ${error.message}`);\n    }\n  }\n  \n  recordTest(name, actual, expected, message) {\n    const passed = actual === expected;\n    this.testResults.push({\n      name,\n      passed,\n      actual,\n      expected,\n      message,\n      timestamp: Date.now()\n    });\n  }\n  \n  summarizeResults() {\n    console.log('\\nðŸ“Š TEST SUMMARY');\n    console.log('===============');\n    \n    const totalTests = this.testResults.length;\n    const passedTests = this.testResults.filter(r => r.passed).length;\n    const failedTests = totalTests - passedTests;\n    \n    console.log(`Total Tests: ${totalTests}`);\n    console.log(`Passed: ${passedTests}`);\n    console.log(`Failed: ${failedTests}`);\n    console.log(`Success Rate: ${((passedTests / totalTests) * 100).toFixed(1)}%`);\n    \n    if (failedTests > 0) {\n      console.log('\\nâŒ Failed Tests:');\n      this.testResults.filter(r => !r.passed).forEach(test => {\n        console.log(`  - ${test.name}: Expected ${test.expected}, got ${test.actual}`);\n        console.log(`    ${test.message}`);\n      });\n    }\n    \n    // Show routing statistics\n    console.log('\\nðŸ“ˆ Router Statistics:');\n    const stats = this.router.getRoutingStats();\n    console.log(`  Total Events: ${stats.total_events}`);\n    console.log(`  Approved: ${stats.approved}`);\n    console.log(`  Denied: ${stats.denied}`);\n    console.log(`  Credits Used: ${stats.credit_usage}`);\n    \n    // Show system status\n    console.log('\\nðŸ”§ System Status:');\n    const status = this.router.getSystemStatus();\n    Object.entries(status).forEach(([key, value]) => {\n      console.log(`  ${key}: ${value}`);\n    });\n  }\n  \n  async testSpecificScenario(scenario) {\n    console.log(`\\nðŸŽ¯ Testing Specific Scenario: ${scenario}`);\n    \n    switch (scenario) {\n      case 'archetype_evolution':\n        await this.testArchetypeEvolution();\n        break;\n      case 'credit_exhaustion':\n        await this.testCreditExhaustion();\n        break;\n      case 'blessing_cascade':\n        await this.testBlessingCascade();\n        break;\n      default:\n        console.log('Unknown scenario');\n    }\n  }\n  \n  async testArchetypeEvolution() {\n    // Test how archetype changes affect routing\n    const mirror = 'mirror-test-evolution';\n    \n    // Register as wanderer\n    this.router.registerMirror(mirror, {\n      archetype: 'wanderer',\n      soulkey: 'sk_test_evolution'\n    });\n    \n    // Test action as wanderer\n    const wandererResult = await this.router.route({\n      mirror_id: mirror,\n      action: 'exploration',\n      archetype: 'wanderer'\n    });\n    \n    console.log(`Wanderer exploration: ${wandererResult.approved ? 'APPROVED' : 'DENIED'}`);\n  }\n  \n  async testCreditExhaustion() {\n    // Test what happens when credits run out\n    const mirror = 'mirror-test-exhaustion';\n    \n    this.router.registerMirror(mirror, {\n      archetype: 'trickster',\n      soulkey: 'sk_test_exhaustion'\n    });\n    \n    // Set low credits\n    this.router.creditBalances.set(mirror, 1);\n    \n    // Try expensive action\n    const expensiveResult = await this.router.route({\n      mirror_id: mirror,\n      action: 'consciousness_merge',\n      archetype: 'trickster'\n    });\n    \n    console.log(`Expensive action with low credits: ${expensiveResult.approved ? 'APPROVED' : 'DENIED'}`);\n    console.log(`Reason: ${expensiveResult.reason}`);\n  }\n  \n  async testBlessingCascade() {\n    // Test blessing inheritance down lineage\n    const parentMirror = 'mirror-test-parent';\n    const childMirror = 'mirror-test-child';\n    \n    // Setup parent with high blessing\n    this.router.registerMirror(parentMirror, {\n      archetype: 'oracle',\n      soulkey: 'sk_test_parent'\n    });\n    \n    this.router.updateBlessing(parentMirror, 5, 'sovereign');\n    \n    // Setup child with lineage\n    this.router.registerMirror(childMirror, {\n      archetype: 'seeker',\n      soulkey: 'sk_test_child'\n    });\n    \n    this.router.establishLineage(childMirror, parentMirror);\n    this.router.inheritBlessings(childMirror);\n    \n    console.log(`Child inherited blessings: ${this.router.getBlessings(childMirror).join(', ')}`);\n    console.log(`Child inherited credits: ${this.router.getCredits(childMirror)}`);\n  }\n}\n\n// Run tests if script is executed directly\nif (require.main === module) {\n  const testSuite = new QuadRouterTestSuite();\n  \n  // Check for specific scenario argument\n  const scenario = process.argv[2];\n  if (scenario) {\n    testSuite.testSpecificScenario(scenario);\n  } else {\n    testSuite.runAllTests();\n  }\n}\n\nmodule.exports = QuadRouterTestSuite;\n"