<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOULFRA ULTIMATE - Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #00ff88;
            --secondary: #00ccff;
            --dark: #0a0a0a;
            --darker: #050505;
            --light: #ffffff;
            --gray: #666;
            --error: #ff4444;
            --warning: #ffaa00;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--dark);
            color: var(--light);
            line-height: 1.6;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, var(--dark) 100%);
            padding: 1.5rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.5);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .status-bar {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--error);
        }
        
        .status-indicator.active {
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
        }
        
        /* Main Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 1.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }
        
        .card h3 {
            margin-bottom: 1rem;
            color: var(--primary);
        }
        
        /* VIBE Display */
        .vibe-display {
            background: linear-gradient(135deg, rgba(0,255,136,0.1), rgba(0,204,255,0.1));
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .vibe-amount {
            font-size: 3rem;
            font-weight: bold;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Controls */
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .control-group:last-child {
            border-bottom: none;
        }
        
        .slider {
            width: 100%;
            margin: 0.5rem 0;
        }
        
        .btn {
            background: var(--primary);
            color: var(--dark);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,255,136,0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .btn-secondary:hover {
            background: var(--primary);
            color: var(--dark);
        }
        
        /* Debug Panel */
        .debug-panel {
            background: rgba(255,68,68,0.1);
            border: 2px solid var(--error);
        }
        
        /* Stripe Integration */
        .payment-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .payment-option {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .payment-option:hover {
            border-color: var(--primary);
            background: rgba(0,255,136,0.1);
        }
        
        .payment-option.selected {
            border-color: var(--primary);
            background: rgba(0,255,136,0.2);
        }
        
        /* Games Grid */
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .game-card {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .game-card:hover {
            background: rgba(0,255,136,0.1);
            transform: scale(1.05);
        }
        
        .game-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        
        /* Personality Store */
        .personality-grid {
            display: grid;
            gap: 1rem;
        }
        
        .personality-card {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .personality-card:hover {
            border-color: var(--primary);
            background: rgba(0,255,136,0.05);
        }
        
        .rarity-legendary {
            border-color: #ff00ff;
            background: rgba(255,0,255,0.05);
        }
        
        .rarity-epic {
            border-color: #9400d3;
            background: rgba(148,0,211,0.05);
        }
        
        .rarity-rare {
            border-color: #0099ff;
            background: rgba(0,153,255,0.05);
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: var(--dark);
            padding: 1rem 2rem;
            border-radius: 8px;
            font-weight: bold;
            animation: slideIn 0.3s ease-out;
            z-index: 1000;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                padding: 1rem;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .status-bar {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">SOULFRA ULTIMATE</div>
            <div class="status-bar">
                <div class="status-item">
                    <span class="status-indicator" id="ollamaStatus"></span>
                    <span>Ollama</span>
                </div>
                <div class="status-item">
                    <span class="status-indicator active"></span>
                    <span>WebSocket</span>
                </div>
                <div class="status-item">
                    <span class="status-indicator" id="stripeStatus"></span>
                    <span>Stripe</span>
                </div>
                <div class="status-item">
                    <span>Soul: <span id="soulSignature">Loading...</span></span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Dashboard -->
    <div class="dashboard-grid">
        <!-- VIBE Balance -->
        <div class="card vibe-display">
            <h3>VIBE Balance</h3>
            <div class="vibe-amount" id="vibeBalance">0</div>
            <p>VIBE Tokens Available</p>
            <div style="margin-top: 2rem;">
                <button class="btn" onclick="showPaymentOptions()">Buy VIBE</button>
            </div>
        </div>

        <!-- Configuration -->
        <div class="card">
            <h3>VIBE Configuration</h3>
            <div class="control-panel">
                <div class="control-group">
                    <label>VIBE per Dollar:</label>
                    <span id="vibePerDollar">10</span>
                </div>
                <input type="range" class="slider" id="vibeSlider" min="1" max="100" value="10" 
                       onchange="updateVibeConfig(this.value)">
                <div class="control-group">
                    <label>Price per VIBE:</label>
                    <span id="vibePrice">$0.10</span>
                </div>
                <div class="control-group">
                    <label>Initial Balance:</label>
                    <input type="number" id="initialBalance" value="10" min="0" max="1000">
                </div>
                <button class="btn btn-secondary" onclick="saveVibeConfig()">Save Config</button>
            </div>
        </div>

        <!-- Ollama Status -->
        <div class="card">
            <h3>AI Engine Status</h3>
            <div class="control-panel">
                <div class="control-group">
                    <label>Ollama:</label>
                    <span id="ollamaStatusText">Checking...</span>
                </div>
                <div class="control-group">
                    <label>Model:</label>
                    <span>Mistral</span>
                </div>
                <div class="control-group">
                    <label>Response Time:</label>
                    <span id="responseTime">N/A</span>
                </div>
                <button class="btn btn-secondary" onclick="testOllama()">Test AI</button>
            </div>
        </div>

        <!-- Games -->
        <div class="card">
            <h3>Available Games</h3>
            <div class="games-grid" id="gamesGrid">
                <!-- Games will be loaded here -->
            </div>
        </div>

        <!-- Personality Store -->
        <div class="card">
            <h3>Personality Store</h3>
            <div class="personality-grid" id="personalityGrid">
                <!-- Personalities will be loaded here -->
            </div>
        </div>

        <!-- Debug Panel -->
        <div class="card debug-panel">
            <h3>ðŸ”§ Debug Panel</h3>
            <div class="control-panel">
                <button class="btn" onclick="grantDebugVibe()">Grant 100 VIBE</button>
                <button class="btn btn-secondary" onclick="resetDatabase()">Reset Database</button>
                <button class="btn btn-secondary" onclick="viewLogs()">View Logs</button>
                <button class="btn btn-secondary" onclick="testWebSocket()">Test WebSocket</button>
            </div>
        </div>

        <!-- Stripe Payments -->
        <div class="card" id="paymentCard" style="display: none;">
            <h3>Purchase VIBE Tokens</h3>
            <div class="payment-options">
                <div class="payment-option" onclick="selectPackage('basic')">
                    <h4>Basic</h4>
                    <div style="font-size: 2rem;">100 VIBE</div>
                    <div>$10</div>
                </div>
                <div class="payment-option" onclick="selectPackage('pro')">
                    <h4>Pro</h4>
                    <div style="font-size: 2rem;">500 VIBE</div>
                    <div>$40</div>
                    <div style="color: var(--primary);">20% Bonus!</div>
                </div>
                <div class="payment-option" onclick="selectPackage('enterprise')">
                    <h4>Enterprise</h4>
                    <div style="font-size: 2rem;">1500 VIBE</div>
                    <div>$100</div>
                    <div style="color: var(--primary);">50% Bonus!</div>
                </div>
            </div>
            <div style="margin-top: 1rem;">
                <button class="btn" onclick="processPayment()">Process Payment</button>
                <button class="btn btn-secondary" onclick="hidePaymentOptions()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    
    <script>
        // Initialize Socket.IO
        const socket = io();
        
        // User state
        const userId = localStorage.getItem('userId') || 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', userId);
        
        let selectedPackage = 'basic';
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeDashboard();
        });
        
        async function initializeDashboard() {
            // Connect socket
            socket.emit('identify', { userId });
            
            // Load user data
            await loadUserData();
            
            // Check services
            await checkServices();
            
            // Load content
            await loadGames();
            await loadPersonalities();
            await loadVibeConfig();
            
            // Set up socket handlers
            setupSocketHandlers();
        }
        
        async function loadUserData() {
            try {
                const response = await fetch(`/api/user/${userId}`);
                const data = await response.json();
                
                document.getElementById('soulSignature').textContent = data.soul_signature || userId;
                document.getElementById('vibeBalance').textContent = Math.floor(data.vibe_balance);
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }
        
        async function checkServices() {
            // Check Ollama
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                const ollamaStatus = document.getElementById('ollamaStatus');
                const ollamaText = document.getElementById('ollamaStatusText');
                
                if (data.ollama) {
                    ollamaStatus.classList.add('active');
                    ollamaText.textContent = 'Connected';
                } else {
                    ollamaText.textContent = 'Using Fallback';
                }
            } catch (error) {
                console.error('Error checking services:', error);
            }
            
            // Check Stripe
            const stripeStatus = document.getElementById('stripeStatus');
            if (window.location.protocol === 'https:' || window.location.hostname !== 'localhost') {
                stripeStatus.classList.add('active');
            }
        }
        
        async function loadGames() {
            try {
                const response = await fetch('/api/games/available');
                const games = await response.json();
                
                const grid = document.getElementById('gamesGrid');
                grid.innerHTML = games.map(game => `
                    <div class="game-card" onclick="launchGame('${game.id}')">
                        <div class="game-icon">ðŸŽ®</div>
                        <h4>${game.name}</h4>
                        <div style="font-size: 0.9rem; color: var(--gray);">
                            ${game.vibe_cost} VIBE
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading games:', error);
            }
        }
        
        async function loadPersonalities() {
            try {
                const response = await fetch('/api/personality/store');
                const personalities = await response.json();
                
                const grid = document.getElementById('personalityGrid');
                grid.innerHTML = personalities.map(p => `
                    <div class="personality-card rarity-${p.rarity}">
                        <div>
                            <h4>${p.name}</h4>
                            <div style="font-size: 0.9rem; color: var(--gray);">
                                ${p.description}
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="purchasePersonality('${p.id}', ${p.vibe_cost})">
                            ${p.vibe_cost} VIBE
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading personalities:', error);
            }
        }
        
        async function loadVibeConfig() {
            try {
                const response = await fetch('/api/config/vibe');
                const config = await response.json();
                
                document.getElementById('vibePerDollar').textContent = config.vibe_per_dollar;
                document.getElementById('vibePrice').textContent = `$${config.vibe_price.toFixed(2)}`;
                document.getElementById('vibeSlider').value = config.vibe_per_dollar;
                document.getElementById('initialBalance').value = config.initial_balance;
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }
        
        function setupSocketHandlers() {
            socket.on('vibe_update', (data) => {
                document.getElementById('vibeBalance').textContent = Math.floor(data.balance);
                showNotification('VIBE balance updated!');
            });
            
            socket.on('vibe_purchased', (data) => {
                document.getElementById('vibeBalance').textContent = Math.floor(data.new_balance);
                showNotification(`+${data.amount} VIBE purchased!`);
            });
        }
        
        // VIBE Configuration
        function updateVibeConfig(value) {
            const vibePerDollar = parseInt(value);
            const vibePrice = (1 / vibePerDollar).toFixed(2);
            
            document.getElementById('vibePerDollar').textContent = vibePerDollar;
            document.getElementById('vibePrice').textContent = `$${vibePrice}`;
        }
        
        async function saveVibeConfig() {
            const config = {
                vibe_per_dollar: parseInt(document.getElementById('vibeSlider').value),
                initial_balance: parseInt(document.getElementById('initialBalance').value)
            };
            
            try {
                const response = await fetch('/api/config/vibe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    showNotification('Configuration saved!');
                }
            } catch (error) {
                console.error('Error saving config:', error);
            }
        }
        
        // Debug Functions
        async function grantDebugVibe() {
            try {
                const response = await fetch(`/api/debug/grant_vibe/${userId}/100`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('vibeBalance').textContent = Math.floor(data.new_balance);
                    showNotification('DEBUG: +100 VIBE granted!');
                }
            } catch (error) {
                console.error('Error granting VIBE:', error);
            }
        }
        
        async function testOllama() {
            try {
                const startTime = Date.now();
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId,
                        message: 'Hello, this is a test message.',
                        tone: 'friendly'
                    })
                });
                
                const data = await response.json();
                const responseTime = Date.now() - startTime;
                
                document.getElementById('responseTime').textContent = `${responseTime}ms`;
                
                if (data.ollama_available) {
                    showNotification('Ollama test successful!');
                } else {
                    showNotification('Using fallback AI responses');
                }
            } catch (error) {
                console.error('Error testing Ollama:', error);
            }
        }
        
        function testWebSocket() {
            socket.emit('test', { message: 'WebSocket test' });
            showNotification('WebSocket test sent!');
        }
        
        // Payment Functions
        function showPaymentOptions() {
            document.getElementById('paymentCard').style.display = 'block';
        }
        
        function hidePaymentOptions() {
            document.getElementById('paymentCard').style.display = 'none';
        }
        
        function selectPackage(pkg) {
            selectedPackage = pkg;
            
            // Update UI
            document.querySelectorAll('.payment-option').forEach(el => {
                el.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }
        
        async function processPayment() {
            try {
                const response = await fetch('/api/stripe/create-payment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId,
                        package: selectedPackage
                    })
                });
                
                const data = await response.json();
                
                if (data.clientSecret) {
                    // In production, this would open Stripe checkout
                    showNotification('Payment integration coming soon!');
                    
                    // For testing, simulate payment success
                    setTimeout(() => {
                        socket.emit('vibe_purchased', {
                            amount: data.vibe,
                            new_balance: parseInt(document.getElementById('vibeBalance').textContent) + data.vibe
                        });
                        hidePaymentOptions();
                    }, 1000);
                }
            } catch (error) {
                console.error('Error processing payment:', error);
            }
        }
        
        // Game Functions
        function launchGame(gameId) {
            showNotification(`Launching ${gameId}...`);
            // In production, this would open the game
            window.open(`/games/${gameId}`, '_blank');
        }
        
        // Personality Functions
        async function purchasePersonality(personalityId, cost) {
            const currentBalance = parseInt(document.getElementById('vibeBalance').textContent);
            
            if (currentBalance < cost) {
                showNotification('Insufficient VIBE!');
                return;
            }
            
            try {
                const response = await fetch('/api/personality/purchase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId,
                        personalityId: personalityId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Personality purchased!`);
                    document.getElementById('vibeBalance').textContent = Math.floor(data.new_balance);
                } else {
                    showNotification(data.error || 'Purchase failed');
                }
            } catch (error) {
                console.error('Error purchasing personality:', error);
            }
        }
        
        // Utility Functions
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        function resetDatabase() {
            if (confirm('Are you sure you want to reset the database?')) {
                showNotification('Database reset not implemented in dashboard');
            }
        }
        
        function viewLogs() {
            window.open('/logs', '_blank');
        }
    </script>
</body>
</html>