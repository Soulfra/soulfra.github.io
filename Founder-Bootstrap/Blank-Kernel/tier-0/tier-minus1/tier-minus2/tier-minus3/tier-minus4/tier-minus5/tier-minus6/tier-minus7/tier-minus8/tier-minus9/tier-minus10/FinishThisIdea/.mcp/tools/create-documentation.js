/**
 * MCP Tool: Create Documentation
 * Generates documentation files with AI assistance
 */

const fs = require('fs').promises;
const path = require('path');

module.exports = {
    name: 'create-documentation',
    description: 'Create a new documentation file with AI-generated content',
    
    parameters: {
        type: 'object',
        properties: {
            category: {
                type: 'string',
                description: 'Documentation category',
                enum: ['overview', 'architecture', 'services', 'implementation', 'deployment', 'api', 'integrations', 'operations', 'troubleshooting']
            },
            filename: {
                type: 'string',
                description: 'Filename for the documentation (without .md extension)'
            },
            title: {
                type: 'string',
                description: 'Title of the documentation'
            },
            description: {
                type: 'string',
                description: 'Brief description of what this documentation covers'
            },
            sections: {
                type: 'array',
                description: 'Main sections to include',
                items: { type: 'string' }
            }
        },
        required: ['category', 'filename', 'title', 'description']
    },
    
    async execute({ category, filename, title, description, sections = [] }) {
        // Map category to directory
        const categoryMap = {
            'overview': '01-overview',
            'architecture': '02-architecture',
            'services': '03-services',
            'implementation': '04-implementation',
            'deployment': '05-deployment',
            'api': '06-api',
            'integrations': '07-integrations',
            'operations': '08-operations',
            'troubleshooting': '09-troubleshooting'
        };
        
        const dir = categoryMap[category];
        if (!dir) {
            throw new Error(`Invalid category: ${category}`);
        }
        
        const projectRoot = process.env.PROJECT_ROOT || path.join(__dirname, '../..');
        const filePath = path.join(projectRoot, 'docs', dir, `${filename}.md`);
        
        // Check if file already exists
        try {
            await fs.access(filePath);
            return {
                success: false,
                error: 'File already exists',
                path: filePath
            };
        } catch (e) {
            // File doesn't exist, continue
        }
        
        // Generate content based on category
        let content = `# ${title}\n\n`;
        content += `## Overview\n\n${description}\n\n`;
        
        // Add default sections based on category
        if (sections.length === 0) {
            switch (category) {
                case 'services':
                    sections = ['Service Details', 'Features', 'Pricing Tiers', 'Technical Implementation', 'Integration Examples', 'Best Practices'];
                    break;
                case 'api':
                    sections = ['Endpoints', 'Authentication', 'Request Format', 'Response Format', 'Error Handling', 'Examples'];
                    break;
                case 'integrations':
                    sections = ['Prerequisites', 'Installation', 'Configuration', 'Usage', 'Advanced Features', 'Troubleshooting'];
                    break;
                case 'operations':
                    sections = ['Requirements', 'Setup', 'Monitoring', 'Maintenance', 'Scaling', 'Troubleshooting'];
                    break;
                case 'troubleshooting':
                    sections = ['Common Issues', 'Error Messages', 'Solutions', 'Prevention', 'Getting Help'];
                    break;
                default:
                    sections = ['Getting Started', 'Key Concepts', 'Examples', 'Best Practices', 'Next Steps'];
            }
        }
        
        // Add sections
        sections.forEach(section => {
            content += `## ${section}\n\n`;
            content += `[Content for ${section} section]\n\n`;
        });
        
        // Add metadata
        content += `---\n\n`;
        content += `*Created: ${new Date().toISOString()}*\n`;
        content += `*Category: ${category}*\n`;
        content += `*Auto-generated by FinishThisIdea MCP Tool*\n`;
        
        // Ensure directory exists
        await fs.mkdir(path.dirname(filePath), { recursive: true });
        
        // Write file
        await fs.writeFile(filePath, content, 'utf8');
        
        // Update memory system
        const memoryUpdate = require('child_process').spawn(
            path.join(projectRoot, 'scripts', 'memory-update.sh'),
            [],
            { cwd: projectRoot }
        );
        
        return {
            success: true,
            path: filePath,
            relativePath: path.relative(projectRoot, filePath),
            content: content,
            message: `Documentation created: ${filename}.md in ${category}`
        };
    }
};