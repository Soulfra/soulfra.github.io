<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soulfra Login</title>
  <meta name="description" content="Complete your Soulfra login - Generating your Ed25519 keys">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #3498db 0%, #2ecc71 50%, #e74c3c 100%);
      color: #fff;
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .auth-container {
      max-width: 500px;
      width: 100%;
      text-align: center;
    }

    .auth-card {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 16px;
      padding: 40px;
      backdrop-filter: blur(10px);
    }

    .logo {
      font-size: 4rem;
      margin-bottom: 10px;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    p {
      opacity: 0.9;
      margin-bottom: 20px;
      font-size: 1.1rem;
    }

    .status {
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      font-weight: 600;
    }

    .status.processing {
      background: rgba(52,152,219,0.2);
      border: 1px solid rgba(52,152,219,0.4);
      color: #3498db;
    }

    .status.success {
      background: rgba(46,204,113,0.2);
      border: 1px solid rgba(46,204,113,0.4);
      color: #2ecc71;
    }

    .status.error {
      background: rgba(231,76,60,0.2);
      border: 1px solid rgba(231,76,60,0.4);
      color: #e74c3c;
    }

    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid #fff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .steps {
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      text-align: left;
    }

    .step {
      padding: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .step-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
    }

    .step-icon.pending {
      background: rgba(255,255,255,0.2);
    }

    .step-icon.active {
      background: #3498db;
      animation: pulse 1.5s ease-in-out infinite;
    }

    .step-icon.complete {
      background: #2ecc71;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    button {
      padding: 15px 30px;
      background: #fff;
      color: #3498db;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1.1rem;
      cursor: pointer;
      transition: transform 0.2s;
      margin-top: 20px;
    }

    button:hover {
      transform: translateY(-2px);
    }

    .key-display {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      word-break: break-all;
      text-align: left;
    }

    .key-display strong {
      color: #2ecc71;
    }

    .hidden {
      display: none;
    }

    .captcha-container {
      margin: 20px 0;
      padding: 20px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
    }

    .captcha-title {
      font-size: 1rem;
      margin-bottom: 15px;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="auth-card">
      <div class="logo">üîê</div>
      <h1>Soulfra Login</h1>
      <p id="mainMessage">Setting up your universal identity...</p>

      <!-- CAPTCHA Verification State -->
      <div id="captchaState">
        <div class="status processing">
          <span>üõ°Ô∏è Verify you're human</span>
        </div>

        <div class="captcha-container">
          <p class="captcha-title">Complete this challenge to continue:</p>
          <!-- Brand CAPTCHA Widget -->
          <div class="brand-captcha"
               data-format="auto"
               data-callback="onCaptchaVerified"></div>
        </div>
      </div>

      <!-- Processing State -->
      <div id="processingState" class="hidden">
        <div class="status processing">
          <div class="spinner"></div>
          <span id="statusMessage">Generating your Ed25519 keys...</span>
        </div>

        <div class="steps">
          <div class="step">
            <div class="step-icon active" id="step1Icon">1</div>
            <span id="step1Text">Generating cryptographic keys</span>
          </div>
          <div class="step">
            <div class="step-icon pending" id="step2Icon">2</div>
            <span id="step2Text">Securing your identity</span>
          </div>
          <div class="step">
            <div class="step-icon pending" id="step3Icon">3</div>
            <span id="step3Text">Syncing with desktop</span>
          </div>
        </div>
      </div>

      <!-- Success State -->
      <div id="successState" class="hidden">
        <div class="status success">
          ‚úì Identity Created Successfully!
        </div>

        <p>Your universal Soulfra identity is ready.</p>

        <div class="key-display">
          <strong>Your User ID:</strong><br>
          <span id="userIdDisplay"></span>
        </div>

        <div class="key-display">
          <strong>Public Key:</strong><br>
          <span id="publicKeyPreview"></span>...
        </div>

        <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 20px;">
          Your private key is securely stored on this device.
          Never share it with anyone.
        </p>

        <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 10px;">
          You can now close this tab and return to your desktop.
        </p>
      </div>

      <!-- Error State -->
      <div id="errorState" class="hidden">
        <div class="status error">
          ‚ùå <span id="errorMessage">Something went wrong</span>
        </div>

        <button onclick="location.reload()">Try Again</button>
      </div>
    </div>
  </div>

  <!-- Brand CAPTCHA Widget -->
  <script src="http://localhost:5001/captcha/widget.js"></script>

  <!-- Soulfra Auth System -->
  <script src="soulfra-universal-auth.js"></script>

  <script>
    let sessionId = null;
    let soulfraAuth = null;
    let captchaVerified = false;
    let captchaToken = null;

    // CAPTCHA verification callback
    window.onCaptchaVerified = function(token) {
      console.log('[SoulfraAuth] CAPTCHA verified:', token);
      captchaVerified = true;
      captchaToken = token;

      // Hide CAPTCHA state, show processing
      document.getElementById('captchaState').classList.add('hidden');
      document.getElementById('processingState').classList.remove('hidden');

      // Continue with authentication
      initializeAuth();
    };

    async function initializeAuth() {
      // Ensure CAPTCHA is verified
      if (!captchaVerified) {
        console.log('[SoulfraAuth] Waiting for CAPTCHA verification...');
        return;
      }
      try {
        // Get session ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        sessionId = urlParams.get('session');

        if (!sessionId) {
          showError('Invalid session. Please scan the QR code again.');
          return;
        }

        console.log('[SoulfraAuth Mobile] Session ID:', sessionId);

        // Step 1: Generate keys
        updateStep(1, 'active', 'Generating cryptographic keys');
        await sleep(500);

        soulfraAuth = new SoulfraUniversalAuth();
        const keys = await soulfraAuth.generateKeyPair();

        updateStep(1, 'complete', 'Keys generated ‚úì');

        // Step 2: Store identity
        updateStep(2, 'active', 'Securing your identity');
        await sleep(500);

        // Generate simple email/name for demo
        const userId = keys.userId;
        const email = `user_${userId}@soulfra.com`;
        const userName = `User ${userId.substring(0, 8)}`;

        soulfraAuth.storeIdentity(email, userName);

        updateStep(2, 'complete', 'Identity secured ‚úì');

        // Step 3: Sync with desktop (via localStorage cross-tab communication)
        updateStep(3, 'active', 'Syncing with desktop');
        await sleep(500);

        // Store session data for desktop to pick up
        const sessionData = {
          userId,
          email,
          userName,
          publicKey: keys.publicKey,
          privateKey: keys.privateKey,
          verified: true,
          timestamp: Date.now()
        };

        localStorage.setItem(`soulfra_session_${sessionId}`, JSON.stringify(sessionData));

        // Also dispatch storage event manually (doesn't fire for same tab)
        window.dispatchEvent(new StorageEvent('storage', {
          key: `soulfra_session_${sessionId}`,
          newValue: JSON.stringify(sessionData)
        }));

        updateStep(3, 'complete', 'Synced with desktop ‚úì');

        // Show success
        await sleep(500);
        showSuccess(userId, keys.publicKey);

        console.log('[SoulfraAuth Mobile] Authentication complete');

      } catch (error) {
        console.error('[SoulfraAuth Mobile] Error:', error);
        showError(error.message || 'Failed to generate identity');
      }
    }

    function updateStep(stepNumber, status, text) {
      const icon = document.getElementById(`step${stepNumber}Icon`);
      const textEl = document.getElementById(`step${stepNumber}Text`);

      // Remove all status classes
      icon.classList.remove('pending', 'active', 'complete');

      // Add new status
      icon.classList.add(status);

      // Update text
      textEl.textContent = text;

      // Update icon content
      if (status === 'complete') {
        icon.textContent = '‚úì';
      } else {
        icon.textContent = stepNumber;
      }
    }

    function showSuccess(userId, publicKey) {
      document.getElementById('processingState').classList.add('hidden');
      document.getElementById('successState').classList.remove('hidden');

      document.getElementById('userIdDisplay').textContent = userId;
      document.getElementById('publicKeyPreview').textContent = publicKey.substring(0, 32);

      // Update main message
      document.getElementById('mainMessage').textContent = 'Welcome to Soulfra!';
    }

    function showError(message) {
      document.getElementById('processingState').classList.add('hidden');
      document.getElementById('errorState').classList.remove('hidden');

      document.getElementById('errorMessage').textContent = message;
      document.getElementById('mainMessage').textContent = 'Authentication Failed';
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Check for session ID on load (but don't initialize auth until CAPTCHA is verified)
    window.addEventListener('load', () => {
      const urlParams = new URLSearchParams(window.location.search);
      sessionId = urlParams.get('session');

      if (!sessionId) {
        showError('Invalid session. Please scan the QR code again.');
      }
    });
  </script>
</body>
</html>
