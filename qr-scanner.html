<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Scan QR Code - CalOS</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      padding: 20px;
      text-align: center;
      background: rgba(0,0,0,0.2);
    }

    .header h1 {
      font-size: 1.5rem;
      margin-bottom: 5px;
    }

    .header p {
      opacity: 0.9;
      font-size: 0.9rem;
    }

    .scanner-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .scanner-box {
      background: rgba(255,255,255,0.1);
      border: 2px dashed rgba(255,255,255,0.5);
      border-radius: 20px;
      width: 280px;
      height: 280px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 30px;
      position: relative;
    }

    .scanner-icon {
      font-size: 4rem;
      opacity: 0.7;
    }

    .status {
      padding: 15px 25px;
      border-radius: 12px;
      font-weight: 600;
      margin: 15px 0;
      text-align: center;
    }

    .status.waiting {
      background: rgba(241,196,15,0.3);
      color: #f1c40f;
    }

    .status.success {
      background: rgba(46,204,113,0.3);
      color: #2ecc71;
    }

    .status.error {
      background: rgba(231,76,60,0.3);
      color: #e74c3c;
    }

    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top: 3px solid #fff;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    button {
      width: calc(100% - 40px);
      max-width: 400px;
      padding: 16px 24px;
      background: #fff;
      color: #667eea;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1.1rem;
      cursor: pointer;
      transition: transform 0.2s;
      margin: 10px 20px;
    }

    button:active {
      transform: scale(0.98);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .instructions {
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 20px;
      margin: 20px;
      max-width: 400px;
    }

    .instructions ul {
      list-style: none;
      margin-top: 10px;
    }

    .instructions li {
      padding: 8px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .instructions li::before {
      content: "âœ“";
      color: #2ecc71;
      font-weight: bold;
      font-size: 1.2rem;
    }

    .hidden {
      display: none;
    }

    /* Camera view (hidden by default, shown when using native camera API) */
    #camera {
      width: 280px;
      height: 280px;
      border-radius: 20px;
      object-fit: cover;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ðŸ”’ CalOS Login</h1>
    <p>Scan QR code from your desktop</p>
  </div>

  <div class="scanner-container">
    <!-- Idle State -->
    <div id="idleState">
      <div class="scanner-box">
        <div class="scanner-icon">ðŸ“±</div>
      </div>
      <button id="scanBtn">Scan QR Code</button>
      <div class="instructions">
        <strong>How it works:</strong>
        <ul>
          <li>Tap "Scan QR Code" below</li>
          <li>Point camera at QR on desktop</li>
          <li>Login happens automatically</li>
        </ul>
      </div>
    </div>

    <!-- Camera State -->
    <div id="cameraState" class="hidden">
      <div class="scanner-box">
        <video id="camera" autoplay playsinline></video>
        <canvas id="canvas" style="display: none;"></canvas>
      </div>
      <div class="status waiting">
        Point camera at QR code...
      </div>
      <button id="cancelBtn">Cancel</button>
    </div>

    <!-- Processing State -->
    <div id="processingState" class="hidden">
      <div class="spinner"></div>
      <div class="status waiting">
        Verifying login...
      </div>
    </div>

    <!-- Success State -->
    <div id="successState" class="hidden">
      <div class="scanner-box" style="border-color: #2ecc71;">
        <div style="font-size: 5rem;">âœ“</div>
      </div>
      <div class="status success">
        Login Successful!
      </div>
      <p style="opacity: 0.9; margin-top: 10px;">Your desktop is now logged in</p>
    </div>

    <!-- Error State -->
    <div id="errorState" class="hidden">
      <div class="scanner-box" style="border-color: #e74c3c;">
        <div style="font-size: 5rem;">âœ—</div>
      </div>
      <div class="status error" id="errorMessage"></div>
      <button id="retryBtn">Try Again</button>
    </div>
  </div>

  <!-- CalOS Identity Tracker -->
  <script src="identity-tracker.js"></script>

  <script>
    let cameraStream = null;
    let scanInterval = null;

    // Show/hide states
    function showState(state) {
      document.getElementById('idleState').classList.add('hidden');
      document.getElementById('cameraState').classList.add('hidden');
      document.getElementById('processingState').classList.add('hidden');
      document.getElementById('successState').classList.add('hidden');
      document.getElementById('errorState').classList.add('hidden');
      document.getElementById(state + 'State').classList.remove('hidden');
    }

    // Start camera
    async function startCamera() {
      try {
        showState('camera');

        const video = document.getElementById('camera');

        // Request camera access
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment', // Use back camera
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });

        video.srcObject = cameraStream;

        // Start scanning for QR codes
        startScanning();

      } catch (error) {
        console.error('Camera error:', error);
        showError('Camera access denied. Please enable camera permissions in settings.');
      }
    }

    // Stop camera
    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
      if (scanInterval) {
        clearInterval(scanInterval);
        scanInterval = null;
      }
    }

    // Scan for QR codes using canvas
    function startScanning() {
      const video = document.getElementById('camera');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');

      scanInterval = setInterval(() => {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

          // Simple QR detection (looks for dark/light patterns)
          // In production, use a library like jsQR
          const qrData = detectQRCode(imageData);

          if (qrData) {
            stopCamera();
            handleQRCode(qrData);
          }
        }
      }, 500); // Scan every 500ms
    }

    // Simplified QR detection (placeholder)
    // In production, use jsQR library: https://github.com/cozmo/jsQR
    function detectQRCode(imageData) {
      // For now, we'll use URL parameter for testing
      const urlParams = new URLSearchParams(window.location.search);
      const sessionId = urlParams.get('sessionId');

      if (sessionId) {
        return JSON.stringify({ sessionId });
      }

      // TODO: Implement actual QR detection with jsQR
      return null;
    }

    // SHA-256 hash function
    async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Get location (with permission)
    async function getLocation() {
      return new Promise((resolve) => {
        if (!navigator.geolocation) {
          resolve({ lat: null, lng: null, error: 'Geolocation not supported' });
          return;
        }

        navigator.geolocation.getCurrentPosition(
          (position) => {
            resolve({
              lat: position.coords.latitude,
              lng: position.coords.longitude,
              accuracy: position.coords.accuracy
            });
          },
          (error) => {
            resolve({ lat: null, lng: null, error: error.message });
          }
        );
      });
    }

    // Handle scanned QR code
    async function handleQRCode(qrData) {
      try {
        showState('processing');

        // Parse QR data (could be JSON or just a code)
        let code;
        try {
          const data = JSON.parse(qrData);
          code = data.sessionId || data.code || qrData;
        } catch {
          // Not JSON, use as-is
          code = qrData.trim();
        }

        // Extract email from code (e.g., "ALICE36212b" â†’ "alice@cringeproof.com")
        const namePart = code.split(/[0-9]/)[0].toLowerCase();
        const email = `${namePart}@cringeproof.com`;

        // Get location + timestamp
        const location = await getLocation();
        const timestamp = Date.now();

        // Create Merkle hash (location + timestamp + code)
        const merkleData = JSON.stringify({ email, location, timestamp, code });
        const merkleHash = await sha256(merkleData);

        // Send to email friends API
        const apiURL = window.location.hostname === 'localhost'
          ? 'http://192.168.1.87:3001'
          : 'https://api.soulfra.com';

        const response = await fetch(`${apiURL}/api/friends/signup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email,
            domain: 'cringeproof.com',
            code,
            location,
            timestamp,
            merkleHash
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Signup failed');
        }

        const result = await response.json();

        if (result.success) {
          // Success!
          showState('success');

          // Store for future use
          localStorage.setItem('cringeproof_email', email);
          localStorage.setItem('cringeproof_code', code);

          // Auto-close after 3 seconds
          setTimeout(() => {
            // Redirect to friends dashboard
            window.location.href = `/email-friends-signup.html?email=${encodeURIComponent(email)}`;
          }, 3000);
        } else {
          throw new Error('Signup failed');
        }

      } catch (error) {
        console.error('QR handling error:', error);
        showError(error.message || 'Failed to process QR code');
      }
    }

    // Show error
    function showError(message) {
      stopCamera();
      document.getElementById('errorMessage').textContent = message;
      showState('error');
    }

    // Event listeners
    document.getElementById('scanBtn').addEventListener('click', startCamera);
    document.getElementById('cancelBtn').addEventListener('click', () => {
      stopCamera();
      showState('idle');
    });
    document.getElementById('retryBtn').addEventListener('click', () => {
      showState('idle');
    });

    // Auto-start camera if sessionId is in URL (deep link from QR scan)
    window.addEventListener('load', () => {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('sessionId')) {
        startCamera();
      }
    });
  </script>
</body>
</html>
