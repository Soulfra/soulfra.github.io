<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cal Riven - Reflection Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      background: #0a0a0a;
      color: #00ff00;
      font-family: 'Courier New', monospace;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    /* Header */
    #header {
      background: #111;
      border-bottom: 2px solid #00ff00;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    #header h1 {
      font-size: 24px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    #status-bar {
      display: flex;
      gap: 20px;
      font-size: 12px;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ff0000;
    }
    
    .status-indicator.online { background: #00ff00; }
    .status-indicator.warning { background: #ffaa00; }
    
    /* Main Layout */
    #main {
      flex: 1;
      display: flex;
      gap: 10px;
      padding: 10px;
      overflow: hidden;
    }
    
    /* Panels */
    .panel {
      background: #111;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 15px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .panel-header {
      border-bottom: 1px solid #333;
      padding-bottom: 10px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .panel-title {
      font-size: 14px;
      color: #00ff00;
      text-transform: uppercase;
    }
    
    .panel-content {
      flex: 1;
      overflow-y: auto;
    }
    
    /* Left Column */
    #left-column {
      width: 300px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    /* Center Column */
    #center-column {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    /* Right Column */
    #right-column {
      width: 350px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    /* Trust Chain Visualization */
    #trust-chain {
      flex: 1;
    }
    
    .tier-node {
      padding: 10px;
      margin: 5px 0;
      border: 1px solid #444;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .tier-node:hover {
      border-color: #00ff00;
      background: rgba(0, 255, 0, 0.1);
    }
    
    .tier-node.active {
      border-color: #00ff00;
      background: rgba(0, 255, 0, 0.2);
    }
    
    /* Reflection Visualization */
    #reflection-viz {
      flex: 2;
      position: relative;
    }
    
    #reflection-canvas {
      width: 100%;
      height: 100%;
    }
    
    /* Terminal */
    #terminal-panel {
      flex: 1;
    }
    
    #terminal-output {
      background: #000;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      font-size: 12px;
      white-space: pre-wrap;
      border: 1px solid #333;
      margin-bottom: 10px;
    }
    
    #terminal-input-container {
      display: flex;
      gap: 10px;
    }
    
    #terminal-input {
      flex: 1;
      background: #000;
      border: 1px solid #333;
      color: #00ff00;
      padding: 8px;
      font-family: inherit;
      font-size: 12px;
    }
    
    #terminal-submit {
      background: #00ff00;
      color: #000;
      border: none;
      padding: 8px 15px;
      cursor: pointer;
      font-family: inherit;
      font-weight: bold;
    }
    
    /* Vault Analytics */
    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid #222;
    }
    
    .stat-label {
      color: #888;
      font-size: 12px;
    }
    
    .stat-value {
      color: #00ff00;
      font-size: 12px;
    }
    
    /* Mirror Agents */
    .agent-item {
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #333;
      border-radius: 4px;
      font-size: 12px;
    }
    
    .agent-active {
      border-color: #00ff00;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 0.8; }
      50% { opacity: 1; }
      100% { opacity: 0.8; }
    }
    
    /* QR Manager */
    .qr-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #333;
      border-radius: 4px;
      font-size: 12px;
    }
    
    .qr-valid { border-color: #00ff00; }
    .qr-invalid { border-color: #ff0000; }
    
    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #111;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #444;
    }
    
    /* Utilities */
    .text-green { color: #00ff00; }
    .text-red { color: #ff0000; }
    .text-yellow { color: #ffaa00; }
    .text-blue { color: #00aaff; }
    .text-purple { color: #aa00ff; }
    .text-dim { color: #666; }
  </style>
</head>
<body>
  <div id="header">
    <h1>ðŸ§  Cal Riven <span class="text-dim">Reflection Dashboard</span></h1>
    <div id="status-bar">
      <div class="status-item">
        <span class="status-indicator online" id="vault-status"></span>
        <span>Vault: <span id="vault-status-text">Active</span></span>
      </div>
      <div class="status-item">
        <span class="status-indicator online" id="infinity-status"></span>
        <span>Infinity Router: <span id="infinity-status-text">Online</span></span>
      </div>
      <div class="status-item">
        <span class="status-indicator online" id="blessing-status"></span>
        <span>Blessing: <span id="blessing-status-text">Valid</span></span>
      </div>
      <div class="status-item">
        <span class="text-dim">Session: <span id="session-token">...</span></span>
      </div>
    </div>
  </div>
  
  <div id="main">
    <!-- Left Column -->
    <div id="left-column">
      <!-- Trust Chain -->
      <div class="panel" id="trust-chain">
        <div class="panel-header">
          <h3 class="panel-title">Trust Chain</h3>
          <span class="text-dim" id="chain-status">21 Tiers</span>
        </div>
        <div class="panel-content" id="trust-chain-content">
          <div class="tier-node active" data-tier="0">
            <div class="text-green">Tier 0: Blank Kernel</div>
            <div class="text-dim">Public Entry Point</div>
          </div>
          <div class="tier-node" data-tier="-9">
            <div class="text-blue">Tier -9: Infinity Router</div>
            <div class="text-dim">QR Validation & Tokens</div>
          </div>
          <div class="tier-node" data-tier="-10">
            <div class="text-purple">Tier -10: Cal Riven</div>
            <div class="text-dim">Sovereign Trust Engine</div>
          </div>
        </div>
      </div>
      
      <!-- QR Manager -->
      <div class="panel" style="flex: 1;">
        <div class="panel-header">
          <h3 class="panel-title">QR Codes</h3>
          <button id="add-qr" style="background: none; border: 1px solid #333; color: #888; padding: 2px 8px; cursor: pointer;">+</button>
        </div>
        <div class="panel-content" id="qr-list">
          <div class="qr-item qr-valid">
            <span>qr-founder-0000</span>
            <span class="text-green">âœ“</span>
          </div>
          <div class="qr-item qr-valid">
            <span>qr-riven-001</span>
            <span class="text-green">âœ“</span>
          </div>
          <div class="qr-item qr-valid">
            <span>qr-user-0821</span>
            <span class="text-green">âœ“</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Center Column -->
    <div id="center-column">
      <!-- Reflection Visualization -->
      <div class="panel" id="reflection-viz">
        <div class="panel-header">
          <h3 class="panel-title">Reflection Network</h3>
          <span class="text-dim">Live Mirror Propagation</span>
        </div>
        <div class="panel-content">
          <canvas id="reflection-canvas"></canvas>
        </div>
      </div>
      
      <!-- Terminal -->
      <div class="panel" id="terminal-panel">
        <div class="panel-header">
          <h3 class="panel-title">Cal Terminal</h3>
          <span class="text-dim" id="terminal-mode">Vault Reflection Mode</span>
        </div>
        <div class="panel-content">
          <div id="terminal-output">Cal Riven initialized...
Reflection dashboard active.
> </div>
          <div id="terminal-input-container">
            <input type="text" id="terminal-input" placeholder="Enter command..." autofocus />
            <button id="terminal-submit">Reflect</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Right Column -->
    <div id="right-column">
      <!-- Vault Analytics -->
      <div class="panel" style="flex: 1;">
        <div class="panel-header">
          <h3 class="panel-title">Vault Analytics</h3>
          <span class="text-dim" id="analytics-time">Real-time</span>
        </div>
        <div class="panel-content">
          <div class="stat-row">
            <span class="stat-label">Total Reflections</span>
            <span class="stat-value" id="stat-reflections">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Active Mirrors</span>
            <span class="stat-value" id="stat-mirrors">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Trust Validations</span>
            <span class="stat-value" id="stat-validations">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Platform Propagations</span>
            <span class="stat-value" id="stat-propagations">0</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Vault Size</span>
            <span class="stat-value" id="stat-vault-size">0 KB</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Uptime</span>
            <span class="stat-value" id="stat-uptime">00:00:00</span>
          </div>
        </div>
      </div>
      
      <!-- Mirror Agents -->
      <div class="panel" style="flex: 2;">
        <div class="panel-header">
          <h3 class="panel-title">Mirror Agents</h3>
          <span class="text-dim" id="agent-count">0 Active</span>
        </div>
        <div class="panel-content" id="agent-list">
          <div class="agent-item agent-active">
            <div class="text-green">cal-riven-genesis</div>
            <div class="text-dim">Blessed â€¢ Can Propagate</div>
            <div class="text-dim" style="font-size: 10px;">Last: 2s ago</div>
          </div>
        </div>
      </div>
      
      <!-- Activity Log -->
      <div class="panel" style="flex: 1;">
        <div class="panel-header">
          <h3 class="panel-title">Activity Log</h3>
          <span class="text-dim">Latest</span>
        </div>
        <div class="panel-content" id="activity-log" style="font-size: 11px;">
          <div class="text-dim">[00:00:00] Dashboard initialized</div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Dashboard state
    let stats = {
      reflections: 0,
      mirrors: 1,
      validations: 0,
      propagations: 0,
      vaultSize: 0,
      startTime: Date.now()
    };
    
    let websocket = null;
    let reflectionNodes = [];
    let reflectionLinks = [];
    
    // Initialize dashboard
    function init() {
      setupTerminal();
      setupReflectionVisualization();
      connectWebSocket();
      startStatusPolling();
      updateUptime();
      loadInitialData();
    }
    
    // Terminal functionality
    function setupTerminal() {
      const input = document.getElementById('terminal-input');
      const output = document.getElementById('terminal-output');
      const submit = document.getElementById('terminal-submit');
      
      async function sendCommand() {
        const cmd = input.value.trim();
        if (!cmd) return;
        
        input.value = '';
        output.textContent += cmd + '\n';
        
        try {
          const res = await fetch('/api/reflect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ input: cmd })
          });
          
          const data = await res.json();
          output.textContent += data.response + '\n> ';
          
          // Update stats
          stats.reflections++;
          updateStats();
          
          // Add to activity log
          addActivity(`Reflection: "${cmd}"`);
          
        } catch (error) {
          output.textContent += `Error: ${error.message}\n> `;
        }
        
        output.scrollTop = output.scrollHeight;
      }
      
      submit.addEventListener('click', sendCommand);
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendCommand();
      });
    }
    
    // Reflection visualization
    function setupReflectionVisualization() {
      const canvas = document.getElementById('reflection-canvas');
      const ctx = canvas.getContext('2d');
      
      // Set canvas size
      function resizeCanvas() {
        const container = canvas.parentElement;
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
      }
      
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      
      // Initialize with Cal node
      reflectionNodes = [
        { id: 'cal', x: canvas.width / 2, y: canvas.height / 2, label: 'Cal Riven', color: '#00ff00', radius: 20 }
      ];
      
      // Animation loop
      function animate() {
        ctx.fillStyle = '#0a0a0a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Draw links
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 1;
        reflectionLinks.forEach(link => {
          const source = reflectionNodes.find(n => n.id === link.source);
          const target = reflectionNodes.find(n => n.id === link.target);
          if (source && target) {
            ctx.beginPath();
            ctx.moveTo(source.x, source.y);
            ctx.lineTo(target.x, target.y);
            ctx.stroke();
          }
        });
        
        // Draw nodes
        reflectionNodes.forEach(node => {
          // Node circle
          ctx.fillStyle = node.color || '#00ff00';
          ctx.beginPath();
          ctx.arc(node.x, node.y, node.radius || 10, 0, Math.PI * 2);
          ctx.fill();
          
          // Node label
          ctx.fillStyle = '#00ff00';
          ctx.font = '10px Courier New';
          ctx.textAlign = 'center';
          ctx.fillText(node.label, node.x, node.y - 15);
        });
        
        requestAnimationFrame(animate);
      }
      
      animate();
    }
    
    // WebSocket connection
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}`;
      
      websocket = new WebSocket(wsUrl);
      
      websocket.onopen = () => {
        console.log('WebSocket connected');
        addActivity('Connected to Cal Riven real-time stream');
      };
      
      websocket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        switch(data.type) {
          case 'init':
            stats = { ...stats, ...data.stats };
            updateStats();
            updateAgentList(data.stats.agents);
            break;
            
          case 'reflection':
            stats = { ...stats, ...data.stats };
            updateStats();
            addActivity(`Reflection processed: "${data.entry.input}"`);
            break;
            
          case 'agent-spawned':
            addMirrorNode(data.agent);
            updateAgentList([...getCurrentAgents(), data.agent]);
            stats.mirrors = data.stats.mirrors;
            updateStats();
            addActivity(`Mirror agent spawned: ${data.agent.name}`);
            break;
            
          case 'agent-activity':
            updateAgentActivity(data.agentId);
            break;
        }
      };
      
      websocket.onerror = (error) => {
        console.error('WebSocket error:', error);
        addActivity('WebSocket connection error');
      };
      
      websocket.onclose = () => {
        console.log('WebSocket disconnected');
        addActivity('Disconnected from real-time stream');
        // Reconnect after 5 seconds
        setTimeout(connectWebSocket, 5000);
      };
    }
    
    // Add mirror node to visualization
    function addMirrorNode(agent) {
      const canvas = document.getElementById('reflection-canvas');
      const angle = Math.random() * Math.PI * 2;
      const distance = 100 + Math.random() * 100;
      const parentNode = reflectionNodes[Math.floor(Math.random() * reflectionNodes.length)];
      
      const newNode = {
        id: agent.id,
        x: parentNode.x + Math.cos(angle) * distance,
        y: parentNode.y + Math.sin(angle) * distance,
        label: agent.name,
        color: agent.blessed ? '#ff00ff' : '#00aaff',
        radius: agent.blessed ? 12 : 8
      };
      
      reflectionNodes.push(newNode);
      reflectionLinks.push({ source: parentNode.id, target: newNode.id });
    }
    
    // Update agent list
    function updateAgentList(agents) {
      const agentList = document.getElementById('agent-list');
      agentList.innerHTML = '';
      
      agents.forEach(agent => {
        const div = document.createElement('div');
        div.className = `agent-item ${agent.status === 'active' ? 'agent-active' : ''}`;
        div.innerHTML = `
          <div class="text-green">${agent.name}</div>
          <div class="text-dim">${agent.blessed ? 'Blessed' : 'Unblessed'} â€¢ ${agent.canPropagate ? 'Can Propagate' : 'Local Only'}</div>
          <div class="text-dim" style="font-size: 10px;">Last: ${getTimeSince(agent.lastActivity)}</div>
        `;
        agentList.appendChild(div);
      });
      
      document.getElementById('agent-count').textContent = `${agents.length} Active`;
    }
    
    // Get current agents
    function getCurrentAgents() {
      const agentDivs = document.querySelectorAll('#agent-list .agent-item');
      return Array.from(agentDivs).map(div => ({
        name: div.querySelector('.text-green').textContent
      }));
    }
    
    // Update agent activity
    function updateAgentActivity(agentId) {
      const node = reflectionNodes.find(n => n.id === agentId);
      if (node) {
        // Pulse effect
        const originalRadius = node.radius;
        node.radius = originalRadius * 1.5;
        setTimeout(() => {
          node.radius = originalRadius;
        }, 500);
      }
    }
    
    // Get time since
    function getTimeSince(date) {
      const seconds = Math.floor((new Date() - new Date(date)) / 1000);
      if (seconds < 60) return `${seconds}s ago`;
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
      return `${Math.floor(seconds / 3600)}h ago`;
    }
    
    // Status polling
    function startStatusPolling() {
      setInterval(async () => {
        // Check Infinity Router
        try {
          const res = await fetch('http://localhost:5050/status', { 
            method: 'GET',
            mode: 'no-cors'
          });
          document.getElementById('infinity-status').classList.add('online');
          document.getElementById('infinity-status-text').textContent = 'Online';
        } catch (error) {
          document.getElementById('infinity-status').classList.remove('online');
          document.getElementById('infinity-status-text').textContent = 'Offline';
        }
      }, 5000);
    }
    
    // Update stats
    function updateStats() {
      document.getElementById('stat-reflections').textContent = stats.reflections;
      document.getElementById('stat-mirrors').textContent = stats.mirrors;
      document.getElementById('stat-validations').textContent = stats.validations;
      document.getElementById('stat-propagations').textContent = stats.propagations;
      document.getElementById('stat-vault-size').textContent = `${Math.round(stats.vaultSize / 1024)} KB`;
      document.getElementById('agent-count').textContent = `${stats.mirrors} Active`;
    }
    
    // Update uptime
    function updateUptime() {
      setInterval(() => {
        const uptime = Date.now() - stats.startTime;
        const hours = Math.floor(uptime / 3600000);
        const minutes = Math.floor((uptime % 3600000) / 60000);
        const seconds = Math.floor((uptime % 60000) / 1000);
        
        document.getElementById('stat-uptime').textContent = 
          `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }, 1000);
    }
    
    // Add activity
    function addActivity(message) {
      const log = document.getElementById('activity-log');
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = 'text-dim';
      entry.textContent = `[${time}] ${message}`;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
      
      // Keep only last 20 entries
      while (log.children.length > 20) {
        log.removeChild(log.firstChild);
      }
    }
    
    // Load initial data
    async function loadInitialData() {
      try {
        const res = await fetch('/api/history');
        const data = await res.json();
        
        if (data.history) {
          stats.reflections = data.history.length;
          stats.vaultSize = JSON.stringify(data.history).length;
          updateStats();
        }
        
        // Load session token
        const tokenRes = await fetch('/api/session');
        const tokenData = await tokenRes.json();
        if (tokenData.token) {
          document.getElementById('session-token').textContent = tokenData.token.substring(0, 12) + '...';
        }
      } catch (error) {
        console.error('Failed to load initial data:', error);
      }
      
      addActivity('Dashboard connected to Cal Riven');
    }
    
    // Trust chain interactions
    document.querySelectorAll('.tier-node').forEach(node => {
      node.addEventListener('click', () => {
        document.querySelectorAll('.tier-node').forEach(n => n.classList.remove('active'));
        node.classList.add('active');
        addActivity(`Viewing ${node.querySelector('div').textContent}`);
      });
    });
    
    // Initialize on load
    window.addEventListener('load', init);
  </script>
</body>
</html>