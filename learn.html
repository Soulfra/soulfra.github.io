<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CalOS - Start Learning Free | No Account Required</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      color: #fff;
    }

    .privacy-banner {
      background: rgba(0, 0, 0, 0.3);
      padding: 12px 20px;
      text-align: center;
      font-size: 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .privacy-banner strong {
      color: #2ecc71;
    }

    .hero {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 40px 20px;
    }

    h1 {
      font-size: 4rem;
      font-weight: 800;
      margin-bottom: 20px;
      text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.3);
    }

    .tagline {
      font-size: 1.5rem;
      margin-bottom: 40px;
      opacity: 0.9;
    }

    .cta-container {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 40px;
    }

    .btn {
      padding: 18px 40px;
      font-size: 1.2rem;
      font-weight: 600;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .btn-primary {
      background: #2ecc71;
      color: #fff;
    }

    .btn-primary:hover {
      background: #27ae60;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      border: 2px solid #fff;
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 30px;
      max-width: 1200px;
      width: 100%;
      margin-top: 60px;
    }

    .feature {
      background: rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .feature-icon {
      font-size: 3rem;
      margin-bottom: 15px;
    }

    .feature h3 {
      font-size: 1.3rem;
      margin-bottom: 10px;
    }

    .feature p {
      opacity: 0.9;
      line-height: 1.6;
    }

    .stats {
      display: flex;
      gap: 40px;
      margin-top: 40px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .stat {
      text-align: center;
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: 800;
      color: #2ecc71;
      display: block;
    }

    .stat-label {
      font-size: 1rem;
      opacity: 0.8;
    }

    .loading {
      text-align: center;
      margin: 20px 0;
      font-size: 1.1rem;
      opacity: 0.8;
    }

    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 3px solid #fff;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .session-info {
      background: rgba(0, 0, 0, 0.3);
      padding: 20px;
      border-radius: 15px;
      margin-top: 40px;
      max-width: 600px;
      text-align: left;
    }

    .session-info h3 {
      margin-bottom: 15px;
      color: #2ecc71;
    }

    .session-info p {
      margin-bottom: 10px;
      line-height: 1.6;
    }

    .suggested-paths {
      display: grid;
      gap: 15px;
      margin-top: 20px;
    }

    .path-card {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .path-card:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: #2ecc71;
      transform: translateX(5px);
    }

    .path-card h4 {
      color: #2ecc71;
      margin-bottom: 5px;
    }

    .path-card p {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .confidence-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 8px;
    }

    .confidence-high { background: #2ecc71; color: #fff; }
    .confidence-medium { background: #f39c12; color: #fff; }
    .confidence-low { background: #95a5a6; color: #fff; }
  </style>
</head>
<body>
  <!-- Privacy Banner -->
  <div class="privacy-banner">
    üç™ <strong>Privacy First:</strong> We analyze cookies to understand your interests but <strong>restore your original cookies on exit</strong>. Zero raw data stored. Your privacy is guaranteed.
  </div>

  <!-- Hero Section -->
  <div class="hero">
    <h1>CalOS</h1>
    <p class="tagline">Learn to Code. Build Real Projects. No Account Required.</p>

    <div class="cta-container">
      <button class="btn btn-primary" id="startFreeLearning">
        üöÄ Start Learning Free
      </button>
      <a href="/login.html" class="btn btn-secondary">
        Sign In to Save Progress
      </a>
    </div>

    <!-- Stats -->
    <div class="stats">
      <div class="stat">
        <span class="stat-number">106</span>
        <span class="stat-label">Free Lessons</span>
      </div>
      <div class="stat">
        <span class="stat-number">12</span>
        <span class="stat-label">Learning Paths</span>
      </div>
      <div class="stat">
        <span class="stat-number">$0</span>
        <span class="stat-label">Cost Forever</span>
      </div>
    </div>

    <!-- Features -->
    <div class="features">
      <div class="feature">
        <div class="feature-icon">üéØ</div>
        <h3>Personalized Paths</h3>
        <p>We analyze your cookies (safely!) to suggest the perfect learning path for you.</p>
      </div>

      <div class="feature">
        <div class="feature-icon">üîí</div>
        <h3>Privacy First</h3>
        <p>Original cookies restored on exit. Zero PII stored. You leave with what you came with.</p>
      </div>

      <div class="feature">
        <div class="feature-icon">‚ö°</div>
        <h3>No Account Needed</h3>
        <p>Start learning instantly. Create account later to save progress forever.</p>
      </div>

      <div class="feature">
        <div class="feature-icon">üèÜ</div>
        <h3>XP & Achievements</h3>
        <p>Earn XP, level up, unlock achievements - even as anonymous user.</p>
      </div>

      <div class="feature">
        <div class="feature-icon">üéì</div>
        <h3>Real Projects</h3>
        <p>Build actual products: receipt parsers, email systems, payment processors.</p>
      </div>

      <div class="feature">
        <div class="feature-icon">üåç</div>
        <h3>12 Domains</h3>
        <p>soulfra.com, vibecoding.com, deathtodata.com, and more - one account for all.</p>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="loading" style="display: none;">
      <div class="spinner"></div>
      <p>Analyzing your interests...</p>
    </div>

    <!-- Session Info -->
    <div id="sessionInfo" class="session-info" style="display: none;">
      <h3>üéØ Your Personalized Learning Path</h3>
      <p id="sessionStats"></p>

      <div class="suggested-paths" id="suggestedPaths"></div>

      <p style="margin-top: 20px; font-size: 0.9rem; opacity: 0.8;">
        üí° <strong>Want to save your progress?</strong> <a href="/login.html" style="color: #2ecc71;">Create account</a> and we'll migrate everything.
      </p>
    </div>
  </div>

  <!-- Load Cookie Snapshot Manager -->
  <script src="/cookie-snapshot-manager.js"></script>

  <!-- Load Identity Tracker -->
  <script src="/identity-tracker.js"></script>

  <!-- Main Application Logic -->
  <script>
    const API_BASE = window.location.origin.includes('github.io')
      ? 'https://api.calos.dev'
      : window.location.origin;

    let sessionStartTime = Date.now();

    // Track page visit
    async function trackPageVisit(elementClicked = null, clickText = null) {
      if (!window.CalOSIdentity) return;

      const timeOnPage = Math.floor((Date.now() - sessionStartTime) / 1000);

      try {
        await fetch(`${API_BASE}/api/learning/track-visit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            fingerprintId: window.CalOSIdentity.fingerprint,
            url: window.location.href,
            pathname: window.location.pathname,
            pageTitle: document.title,
            referrer: document.referrer,
            elementClicked,
            clickText,
            timeOnPageSeconds: timeOnPage,
            interestsDetected: window.CalOSIdentity.getSuggestedPaths().map(p => p.path)
          })
        });
      } catch (error) {
        console.warn('[CalOS] Could not track visit:', error);
      }
    }

    // Start Learning Free button
    document.getElementById('startFreeLearning').addEventListener('click', async function() {
      const btn = this;
      btn.disabled = true;
      btn.textContent = 'üîÑ Setting up...';

      // Track click
      await trackPageVisit('button', 'Start Learning Free');

      // Show loading
      document.getElementById('loading').style.display = 'block';

      try {
        // Wait for identity to be ready
        await new Promise(resolve => {
          const checkIdentity = () => {
            if (window.CalOSIdentity && window.CalOSIdentity.fingerprint) {
              resolve();
            } else {
              setTimeout(checkIdentity, 100);
            }
          };
          checkIdentity();
        });

        // Get cookie data
        const cookieReport = window.CalOSIdentity.getCookieReport();
        const suggestedPaths = window.CalOSIdentity.getSuggestedPaths();

        // Start free learning session
        const response = await fetch(`${API_BASE}/api/learning/start-free`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            fingerprintId: window.CalOSIdentity.fingerprint,
            cookieInterests: cookieReport?.dataStored ? window.CalOSIdentity.cookieManager.inferredInterests : {},
            cookieCategories: cookieReport?.dataStored ? window.CalOSIdentity.cookieManager.cookieCategories : {},
            suggestedPaths: suggestedPaths
          })
        });

        const data = await response.json();

        if (data.success) {
          // Hide loading
          document.getElementById('loading').style.display = 'none';

          // Show session info
          const sessionInfo = document.getElementById('sessionInfo');
          const sessionStats = document.getElementById('sessionStats');

          sessionStats.textContent = `Based on your cookies and interests, we've personalized your learning experience. You have ${data.session.xp} XP and are Level ${data.session.level}.`;

          // Display suggested paths
          const pathsContainer = document.getElementById('suggestedPaths');
          pathsContainer.innerHTML = '';

          suggestedPaths.forEach(path => {
            const card = document.createElement('div');
            card.className = 'path-card';
            card.innerHTML = `
              <h4>${path.path.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h4>
              <p>${path.reason}</p>
              <span class="confidence-badge confidence-${path.confidence}">${path.confidence} confidence</span>
            `;

            card.addEventListener('click', () => {
              // Track click and redirect to learning path
              trackPageVisit('path-card', path.path);
              window.location.href = `/learn/${path.path}`;
            });

            pathsContainer.appendChild(card);
          });

          sessionInfo.style.display = 'block';

          // Scroll to session info
          sessionInfo.scrollIntoView({ behavior: 'smooth' });
        } else {
          throw new Error(data.message || 'Failed to start session');
        }

      } catch (error) {
        console.error('[CalOS] Error starting free learning:', error);
        alert('Oops! Something went wrong. Please try again.');
        btn.disabled = false;
        btn.textContent = 'üöÄ Start Learning Free';
        document.getElementById('loading').style.display = 'none';
      }
    });

    // Track all clicks
    document.addEventListener('click', (e) => {
      if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') {
        const text = e.target.textContent.substring(0, 50);
        trackPageVisit(e.target.tagName.toLowerCase(), text);
      }
    });

    // Track page exit (save time on page)
    window.addEventListener('beforeunload', () => {
      trackPageVisit('page-exit', 'leaving-page');
    });

    console.log('%cüöÄ CalOS Homepage Ready', 'color: #2ecc71; font-size: 1.5rem; font-weight: bold;');
    console.log('%cClick "Start Learning Free" to begin!', 'color: #888;');
  </script>
</body>
</html>
