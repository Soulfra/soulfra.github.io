<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Soulfra Mobile - AI Agent Control Center</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Soulfra">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==">
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .glow-button {
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
            transition: all 0.3s ease;
        }
        .glow-button:hover {
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.8);
            transform: translateY(-2px);
        }
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .pulse-ring {
            animation: pulseRing 2s infinite;
        }
        @keyframes pulseRing {
            0% { transform: scale(0.33); }
            80%, 100% { opacity: 0; }
        }
        .voice-wave {
            animation: voiceWave 1.5s ease-in-out infinite alternate;
        }
        @keyframes voiceWave {
            from { height: 20px; }
            to { height: 40px; }
        }
        
        /* Mobile-optimized styles */
        .mobile-safe {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .touch-target {
            min-height: 48px;
            min-width: 48px;
        }
        
        /* Haptic feedback simulation */
        .haptic-light { animation: hapticLight 0.1s ease; }
        .haptic-medium { animation: hapticMedium 0.15s ease; }
        .haptic-heavy { animation: hapticHeavy 0.2s ease; }
        
        @keyframes hapticLight {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        @keyframes hapticMedium {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes hapticHeavy {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white overflow-x-hidden">
    <!-- Status Bar -->
    <div class="fixed top-0 left-0 right-0 z-50 glass-card px-4 py-2 flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <div id="connection-status" class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
            <span class="text-sm font-medium">Soulfra Live</span>
        </div>
        <div class="flex items-center space-x-3">
            <div id="vibe-score-mini" class="text-sm font-bold">75</div>
            <button id="settings-btn" class="touch-target p-2">‚öôÔ∏è</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="pt-16 pb-20 px-4 min-h-screen">
        <!-- Quick Stats Card -->
        <div class="glass-card rounded-2xl p-6 mb-6 fade-in">
            <h2 class="text-xl font-bold mb-4">Agent Control Center</h2>
            <div class="grid grid-cols-2 gap-4">
                <div class="text-center">
                    <div id="active-agents" class="text-2xl font-bold text-green-400">0</div>
                    <div class="text-sm opacity-75">Active Agents</div>
                </div>
                <div class="text-center">
                    <div id="total-executions" class="text-2xl font-bold text-blue-400">0</div>
                    <div class="text-sm opacity-75">Executions Today</div>
                </div>
            </div>
        </div>

        <!-- Voice Control Section -->
        <div class="glass-card rounded-2xl p-6 mb-6 slide-up">
            <h3 class="text-lg font-bold mb-4 flex items-center">
                üé§ Voice Agent Command
            </h3>
            
            <div class="relative">
                <button id="voice-btn" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl p-6 touch-target glow-button">
                    <div class="flex flex-col items-center">
                        <div id="voice-icon" class="text-4xl mb-2">üéôÔ∏è</div>
                        <div id="voice-status" class="text-lg font-semibold">Tap to Speak</div>
                        <div id="voice-subtitle" class="text-sm opacity-75">Create agents with your voice</div>
                    </div>
                </button>
                
                <!-- Voice Wave Animation -->
                <div id="voice-waves" class="hidden absolute inset-0 flex items-center justify-center">
                    <div class="flex space-x-1">
                        <div class="w-1 bg-white voice-wave rounded-full"></div>
                        <div class="w-1 bg-white voice-wave rounded-full" style="animation-delay: 0.1s;"></div>
                        <div class="w-1 bg-white voice-wave rounded-full" style="animation-delay: 0.2s;"></div>
                        <div class="w-1 bg-white voice-wave rounded-full" style="animation-delay: 0.3s;"></div>
                        <div class="w-1 bg-white voice-wave rounded-full" style="animation-delay: 0.4s;"></div>
                    </div>
                </div>
            </div>
            
            <div id="voice-transcript" class="hidden mt-4 p-3 bg-black bg-opacity-30 rounded-lg">
                <div class="text-sm opacity-75 mb-1">Transcript:</div>
                <div id="transcript-text" class="text-sm"></div>
            </div>
        </div>

        <!-- Quick Actions Grid -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <button class="quick-action glass-card rounded-xl p-4 touch-target" data-action="create-agent">
                <div class="text-2xl mb-2">üî®</div>
                <div class="text-sm font-semibold">Create Agent</div>
            </button>
            <button class="quick-action glass-card rounded-xl p-4 touch-target" data-action="marketplace">
                <div class="text-2xl mb-2">üõçÔ∏è</div>
                <div class="text-sm font-semibold">Marketplace</div>
            </button>
            <button class="quick-action glass-card rounded-xl p-4 touch-target" data-action="analytics">
                <div class="text-2xl mb-2">üìä</div>
                <div class="text-sm font-semibold">Analytics</div>
            </button>
            <button class="quick-action glass-card rounded-xl p-4 touch-target" data-action="earnings">
                <div class="text-2xl mb-2">üí∞</div>
                <div class="text-sm font-semibold">Earnings</div>
            </button>
        </div>

        <!-- Recent Activity -->
        <div class="glass-card rounded-2xl p-6 mb-6">
            <h3 class="text-lg font-bold mb-4">Recent Activity</h3>
            <div id="activity-feed" class="space-y-3">
                <!-- Activity items will be populated here -->
            </div>
        </div>

        <!-- Emergency Actions -->
        <div class="glass-card rounded-2xl p-6 mb-6">
            <h3 class="text-lg font-bold mb-4 text-red-400">Emergency Controls</h3>
            <div class="grid grid-cols-2 gap-3">
                <button id="pause-all-btn" class="bg-yellow-600 rounded-lg p-3 text-sm font-semibold touch-target">
                    ‚è∏Ô∏è Pause All Agents
                </button>
                <button id="emergency-stop-btn" class="bg-red-600 rounded-lg p-3 text-sm font-semibold touch-target">
                    üõë Emergency Stop
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="fixed bottom-0 left-0 right-0 glass-card mobile-safe">
        <div class="flex justify-around py-3">
            <button class="nav-btn touch-target p-3 rounded-lg" data-tab="home">
                <div class="text-xl">üè†</div>
                <div class="text-xs">Home</div>
            </button>
            <button class="nav-btn touch-target p-3 rounded-lg" data-tab="agents">
                <div class="text-xl">ü§ñ</div>
                <div class="text-xs">Agents</div>
            </button>
            <button class="nav-btn touch-target p-3 rounded-lg" data-tab="voice">
                <div class="text-xl">üéôÔ∏è</div>
                <div class="text-xs">Voice</div>
            </button>
            <button class="nav-btn touch-target p-3 rounded-lg" data-tab="profile">
                <div class="text-xl">üë§</div>
                <div class="text-xs">Profile</div>
            </button>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button id="fab" class="fixed bottom-24 right-6 w-14 h-14 bg-green-600 rounded-full flex items-center justify-center glow-button z-40">
        <span class="text-2xl">‚ö°</span>
    </button>

    <!-- Modal Overlay -->
    <div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div id="modal-content" class="glass-card rounded-2xl p-6 w-full max-w-sm">
            <!-- Modal content will be populated here -->
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed top-20 left-4 right-4 z-40">
        <!-- Toast notifications will appear here -->
    </div>

    <!-- PWA Install Prompt -->
    <div id="install-prompt" class="hidden fixed bottom-24 left-4 right-4 glass-card rounded-xl p-4 z-30">
        <div class="flex items-center justify-between">
            <div>
                <div class="font-semibold">Install Soulfra Mobile</div>
                <div class="text-sm opacity-75">Add to home screen for better experience</div>
            </div>
            <button id="install-btn" class="bg-blue-600 px-4 py-2 rounded-lg text-sm font-semibold">
                Install
            </button>
        </div>
    </div>

    <script>
        // Global state
        let userFingerprint = null;
        let isVoiceActive = false;
        let recognition = null;
        let currentTab = 'home';
        let deferredPrompt = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            console.log('üöÄ Initializing Soulfra Mobile...');
            
            // Initialize user session
            await createFingerprint();
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize voice recognition
            initializeVoiceRecognition();
            
            // Load initial data
            await loadDashboardData();
            
            // Setup PWA features
            setupPWA();
            
            // Start real-time updates
            startRealtimeUpdates();
            
            console.log('‚úÖ Soulfra Mobile ready!');
            showToast('üåå Soulfra Mobile ready!', 'success');
        }

        async function createFingerprint() {
            try {
                const deviceInfo = {
                    userAgent: navigator.userAgent,
                    language: navigator.language,
                    platform: navigator.platform,
                    screenResolution: `${screen.width}x${screen.height}`,
                    touchPoints: navigator.maxTouchPoints,
                    timestamp: Date.now()
                };

                const response = await fetch('/api/auth/fingerprint', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ deviceInfo })
                });

                const data = await response.json();
                if (data.success) {
                    userFingerprint = data.fingerprint.fingerprintId;
                    localStorage.setItem('soulfra_mobile_fingerprint', userFingerprint);
                }
            } catch (error) {
                console.error('Fingerprint creation failed:', error);
                userFingerprint = localStorage.getItem('soulfra_mobile_fingerprint') || 'mobile_user';
            }
        }

        function setupEventListeners() {
            // Voice button
            document.getElementById('voice-btn').addEventListener('click', toggleVoiceRecognition);
            
            // Quick actions
            document.querySelectorAll('.quick-action').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    hapticFeedback('light');
                    handleQuickAction(btn.dataset.action);
                });
            });
            
            // Navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    hapticFeedback('light');
                    switchTab(btn.dataset.tab);
                });
            });
            
            // FAB
            document.getElementById('fab').addEventListener('click', () => {
                hapticFeedback('medium');
                quickExecute();
            });
            
            // Emergency controls
            document.getElementById('pause-all-btn').addEventListener('click', () => {
                hapticFeedback('heavy');
                pauseAllAgents();
            });
            
            document.getElementById('emergency-stop-btn').addEventListener('click', () => {
                hapticFeedback('heavy');
                emergencyStop();
            });
            
            // Modal close
            document.getElementById('modal-overlay').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    closeModal();
                }
            });
        }

        function initializeVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                
                recognition.onstart = () => {
                    console.log('üé§ Voice recognition started');
                    document.getElementById('voice-icon').textContent = 'üî¥';
                    document.getElementById('voice-status').textContent = 'Listening...';
                    document.getElementById('voice-subtitle').textContent = 'Speak now';
                    document.getElementById('voice-waves').classList.remove('hidden');
                    isVoiceActive = true;
                };
                
                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    const transcriptEl = document.getElementById('transcript-text');
                    transcriptEl.textContent = finalTranscript + interimTranscript;
                    document.getElementById('voice-transcript').classList.remove('hidden');
                    
                    if (finalTranscript) {
                        processVoiceCommand(finalTranscript);
                    }
                };
                
                recognition.onerror = (event) => {
                    console.error('Voice recognition error:', event.error);
                    resetVoiceUI();
                    showToast('Voice recognition error', 'error');
                };
                
                recognition.onend = () => {
                    console.log('üé§ Voice recognition ended');
                    resetVoiceUI();
                };
            } else {
                console.log('Voice recognition not supported');
                document.getElementById('voice-btn').style.opacity = '0.5';
                document.getElementById('voice-subtitle').textContent = 'Voice not supported';
            }
        }

        function toggleVoiceRecognition() {
            if (!recognition) {
                showToast('Voice recognition not available', 'error');
                return;
            }

            if (isVoiceActive) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        function resetVoiceUI() {
            document.getElementById('voice-icon').textContent = 'üéôÔ∏è';
            document.getElementById('voice-status').textContent = 'Tap to Speak';
            document.getElementById('voice-subtitle').textContent = 'Create agents with your voice';
            document.getElementById('voice-waves').classList.add('hidden');
            isVoiceActive = false;
        }

        async function processVoiceCommand(transcript) {
            console.log('Processing voice command:', transcript);
            showToast('Processing: ' + transcript, 'info');
            
            // Simple voice command processing
            const command = transcript.toLowerCase();
            
            if (command.includes('create agent') || command.includes('make agent')) {
                const agentDescription = transcript.replace(/create agent|make agent/gi, '').trim();
                await createAgentFromVoice(agentDescription);
            } else if (command.includes('show stats') || command.includes('analytics')) {
                handleQuickAction('analytics');
            } else if (command.includes('marketplace')) {
                handleQuickAction('marketplace');
            } else if (command.includes('earnings') || command.includes('money')) {
                handleQuickAction('earnings');
            } else {
                // General agent execution
                await executeAgentFromVoice(transcript);
            }
        }

        async function createAgentFromVoice(description) {
            if (!description) {
                showToast('Please describe what the agent should do', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/agents/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: `Voice Agent ${Date.now()}`,
                        description: description,
                        code: `function process(input) { return "Voice-created agent processed: " + input; }`,
                        type: 'voice-created',
                        public: true,
                        fingerprintId: userFingerprint
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showToast('üéâ Agent created from voice!', 'success');
                    await loadDashboardData();
                } else {
                    showToast('Failed to create agent: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('Voice agent creation failed', 'error');
            }
        }

        async function executeAgentFromVoice(input) {
            try {
                // Get available agents
                const agentsResponse = await fetch('/api/agents/public');
                const agentsData = await agentsResponse.json();
                
                if (!agentsData.success || agentsData.agents.length === 0) {
                    showToast('No agents available', 'warning');
                    return;
                }

                // Execute with first agent
                const response = await fetch('/api/agents/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agentId: agentsData.agents[0].id,
                        input: input,
                        fingerprintId: userFingerprint
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showToast(`‚úÖ Agent executed! Cost: $${data.execution.price}`, 'success');
                    addActivityItem('Agent execution', `Processed: "${input}"`, 'success');
                } else {
                    showToast('Execution failed: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('Voice execution failed', 'error');
            }
        }

        function handleQuickAction(action) {
            console.log('Quick action:', action);
            
            switch (action) {
                case 'create-agent':
                    showCreateAgentModal();
                    break;
                case 'marketplace':
                    showToast('Opening marketplace...', 'info');
                    // In a real app, would navigate to marketplace
                    break;
                case 'analytics':
                    showAnalyticsModal();
                    break;
                case 'earnings':
                    showEarningsModal();
                    break;
            }
        }

        function showCreateAgentModal() {
            const modalContent = `
                <h3 class="text-xl font-bold mb-4">Create New Agent</h3>
                <div class="space-y-4">
                    <input type="text" id="agent-name" placeholder="Agent name..." 
                           class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-white placeholder-opacity-60">
                    <textarea id="agent-description" placeholder="What does it do?" 
                              class="w-full p-3 rounded-lg bg-white bg-opacity-20 text-white placeholder-white placeholder-opacity-60 resize-none" 
                              rows="3"></textarea>
                    <div class="flex space-x-3">
                        <button onclick="closeModal()" class="flex-1 bg-gray-600 py-3 rounded-lg">Cancel</button>
                        <button onclick="createAgent()" class="flex-1 bg-green-600 py-3 rounded-lg font-semibold">Create</button>
                    </div>
                </div>
            `;
            showModal(modalContent);
        }

        function showAnalyticsModal() {
            const modalContent = `
                <h3 class="text-xl font-bold mb-4">Analytics</h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-blue-500 bg-opacity-20 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold" id="modal-executions">0</div>
                            <div class="text-xs">Executions</div>
                        </div>
                        <div class="bg-green-500 bg-opacity-20 p-3 rounded-lg text-center">
                            <div class="text-lg font-bold" id="modal-revenue">$0</div>
                            <div class="text-xs">Revenue</div>
                        </div>
                    </div>
                    <button onclick="closeModal()" class="w-full bg-blue-600 py-3 rounded-lg">Close</button>
                </div>
            `;
            showModal(modalContent);
        }

        function showEarningsModal() {
            const modalContent = `
                <h3 class="text-xl font-bold mb-4">üí∞ Earnings</h3>
                <div class="space-y-4">
                    <div class="bg-green-500 bg-opacity-20 p-4 rounded-lg">
                        <div class="text-2xl font-bold">$0.00</div>
                        <div class="text-sm opacity-75">Total Earnings</div>
                    </div>
                    <div class="bg-blue-500 bg-opacity-20 p-4 rounded-lg">
                        <div class="text-xl font-bold">$0.00</div>
                        <div class="text-sm opacity-75">This Month</div>
                    </div>
                    <button onclick="closeModal()" class="w-full bg-green-600 py-3 rounded-lg">Close</button>
                </div>
            `;
            showModal(modalContent);
        }

        function showModal(content) {
            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.add('hidden');
        }

        async function createAgent() {
            const name = document.getElementById('agent-name').value;
            const description = document.getElementById('agent-description').value;

            if (!name || !description) {
                showToast('Please fill in all fields', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/agents/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        description,
                        code: `function process(input) { return "${name} processed: " + input; }`,
                        type: 'mobile-created',
                        public: true,
                        fingerprintId: userFingerprint
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showToast('üéâ Agent created successfully!', 'success');
                    closeModal();
                    await loadDashboardData();
                    addActivityItem('Agent created', name, 'success');
                } else {
                    showToast('Failed to create agent: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('Agent creation failed', 'error');
            }
        }

        async function quickExecute() {
            try {
                const agentsResponse = await fetch('/api/agents/public');
                const agentsData = await agentsResponse.json();
                
                if (!agentsData.success || agentsData.agents.length === 0) {
                    showToast('No agents available', 'warning');
                    return;
                }

                const response = await fetch('/api/agents/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agentId: agentsData.agents[0].id,
                        input: 'Quick mobile execution',
                        fingerprintId: userFingerprint
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showToast(`‚ö° Quick execution completed! $${data.execution.price}`, 'success');
                    addActivityItem('Quick execution', 'Mobile quick execute', 'success');
                    await loadDashboardData();
                } else {
                    showToast('Quick execution failed', 'error');
                }
            } catch (error) {
                showToast('Quick execution failed', 'error');
            }
        }

        function pauseAllAgents() {
            showToast('üî¥ All agents paused', 'warning');
            addActivityItem('System action', 'All agents paused', 'warning');
        }

        function emergencyStop() {
            showToast('üõë Emergency stop activated!', 'error');
            addActivityItem('Emergency action', 'Platform emergency stop', 'error');
        }

        function switchTab(tab) {
            currentTab = tab;
            
            // Update navigation UI
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600');
                if (btn.dataset.tab === tab) {
                    btn.classList.add('bg-blue-600');
                }
            });
            
            console.log('Switched to tab:', tab);
        }

        async function loadDashboardData() {
            try {
                const response = await fetch('/api/analytics/platform');
                const data = await response.json();
                
                if (data.success) {
                    updateStats(data.metrics);
                }

                // Load trust score
                const trustResponse = await fetch(`/api/trust/score/${userFingerprint}`);
                const trustData = await trustResponse.json();
                
                if (trustData.success) {
                    document.getElementById('vibe-score-mini').textContent = trustData.vibeScore;
                }
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
            }
        }

        function updateStats(metrics) {
            const platform = metrics.platform || {};
            
            document.getElementById('active-agents').textContent = platform.totalAgents || 0;
            document.getElementById('total-executions').textContent = platform.totalExecutions || 0;
        }

        function addActivityItem(type, description, status) {
            const feed = document.getElementById('activity-feed');
            const item = document.createElement('div');
            
            const statusColors = {
                success: 'text-green-400',
                warning: 'text-yellow-400',
                error: 'text-red-400'
            };
            
            item.className = 'flex items-center space-x-3 p-3 bg-black bg-opacity-20 rounded-lg';
            item.innerHTML = `
                <div class="w-2 h-2 rounded-full bg-current ${statusColors[status]}"></div>
                <div class="flex-1">
                    <div class="text-sm font-semibold">${type}</div>
                    <div class="text-xs opacity-75">${description}</div>
                </div>
                <div class="text-xs opacity-50">${new Date().toLocaleTimeString()}</div>
            `;
            
            feed.insertBefore(item, feed.firstChild);
            
            // Keep only last 5 items
            while (feed.children.length > 5) {
                feed.removeChild(feed.lastChild);
            }
        }

        function hapticFeedback(intensity) {
            // Simulate haptic feedback with visual feedback
            const target = event.target.closest('button');
            if (target) {
                target.classList.add(`haptic-${intensity}`);
                setTimeout(() => {
                    target.classList.remove(`haptic-${intensity}`);
                }, intensity === 'light' ? 100 : intensity === 'medium' ? 150 : 200);
            }
            
            // Try actual haptic feedback if available
            if ('vibrate' in navigator) {
                const patterns = {
                    light: [50],
                    medium: [100],
                    heavy: [200]
                };
                navigator.vibrate(patterns[intensity]);
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-yellow-600',
                info: 'bg-blue-600'
            };
            
            toast.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg mb-2 slide-up`;
            toast.textContent = message;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function setupPWA() {
            // Handle install prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('install-prompt').classList.remove('hidden');
            });

            document.getElementById('install-btn').addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const result = await deferredPrompt.userChoice;
                    
                    if (result.outcome === 'accepted') {
                        showToast('üéâ Soulfra Mobile installed!', 'success');
                    }
                    
                    deferredPrompt = null;
                    document.getElementById('install-prompt').classList.add('hidden');
                }
            });

            // Register service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(() => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed'));
            }
        }

        function startRealtimeUpdates() {
            setInterval(async () => {
                await loadDashboardData();
            }, 30000); // Update every 30 seconds
        }

        // Add initial activity items
        setTimeout(() => {
            addActivityItem('System', 'Soulfra Mobile initialized', 'success');
        }, 1000);
    </script>
</body>
</html>