# Soulfra Platform - Windows Zip Diff Tool
# PowerShell version for Windows development teams

param(
    [Parameter(Mandatory=$true)]
    [string]$OldZip,
    
    [Parameter(Mandatory=$true)]
    [string]$NewZip,
    
    [string]$OutputDir = ".\diff_reports",
    [switch]$SummaryOnly
)

# Colors for console output
$ErrorColor = "Red"
$SuccessColor = "Green"
$InfoColor = "Cyan"
$WarningColor = "Yellow"

function Write-Status {
    param([string]$Message)
    Write-Host "[INFO] $Message" -ForegroundColor $InfoColor
}

function Write-Success {
    param([string]$Message)
    Write-Host "[SUCCESS] $Message" -ForegroundColor $SuccessColor
}

function Write-Warning {
    param([string]$Message)
    Write-Host "[WARNING] $Message" -ForegroundColor $WarningColor
}

function Write-Error {
    param([string]$Message)
    Write-Host "[ERROR] $Message" -ForegroundColor $ErrorColor
}

# Validate input files
if (!(Test-Path $OldZip)) {
    Write-Error "Old zip file not found: $OldZip"
    exit 1
}

if (!(Test-Path $NewZip)) {
    Write-Error "New zip file not found: $NewZip"
    exit 1
}

# Create output directory
if (!(Test-Path $OutputDir)) {
    New-Item -ItemType Directory -Path $OutputDir -Force | Out-Null
}

# Create temporary directories
$TempDir = Join-Path $env:TEMP "soulfra_diff_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
$OldDir = Join-Path $TempDir "old"
$NewDir = Join-Path $TempDir "new"

New-Item -ItemType Directory -Path $OldDir -Force | Out-Null
New-Item -ItemType Directory -Path $NewDir -Force | Out-Null

Write-Status "Starting Soulfra Platform Zip Comparison..."
Write-Host "Old version: $OldZip"
Write-Host "New version: $NewZip"
Write-Host "Output directory: $OutputDir"
Write-Host ""

try {
    # Extract zip files
    Write-Status "Extracting $OldZip..."
    Expand-Archive -Path $OldZip -DestinationPath $OldDir -Force
    
    Write-Status "Extracting $NewZip..."
    Expand-Archive -Path $NewZip -DestinationPath $NewDir -Force
    
    # Generate timestamp for report files
    $Timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
    $ReportPrefix = "soulfra_diff_$Timestamp"
    
    # Get file lists
    Write-Status "Analyzing file changes..."
    
    $OldFiles = Get-ChildItem -Path $OldDir -Recurse -File | ForEach-Object { $_.FullName.Replace($OldDir + "\", "") } | Sort-Object
    $NewFiles = Get-ChildItem -Path $NewDir -Recurse -File | ForEach-Object { $_.FullName.Replace($NewDir + "\", "") } | Sort-Object
    
    # Find differences
    $AddedFiles = Compare-Object $OldFiles $NewFiles | Where-Object { $_.SideIndicator -eq "=>" } | Select-Object -ExpandProperty InputObject
    $RemovedFiles = Compare-Object $OldFiles $NewFiles | Where-Object { $_.SideIndicator -eq "<=" } | Select-Object -ExpandProperty InputObject
    $CommonFiles = Compare-Object $OldFiles $NewFiles -IncludeEqual | Where-Object { $_.SideIndicator -eq "==" } | Select-Object -ExpandProperty InputObject
    
    # Count changes
    $AddedCount = if ($AddedFiles) { $AddedFiles.Count } else { 0 }
    $RemovedCount = if ($RemovedFiles) { $RemovedFiles.Count } else { 0 }
    $CommonCount = if ($CommonFiles) { $CommonFiles.Count } else { 0 }
    
    # Generate summary report
    $SummaryFile = Join-Path $OutputDir "${ReportPrefix}_summary.txt"
    $SummaryContent = @"
Soulfra Platform Diff Summary
Generated: $(Get-Date)
Old Version: $OldZip
New Version: $NewZip

CHANGE SUMMARY:
===============
Files Added:    $AddedCount
Files Removed:  $RemovedCount
Files Common:   $CommonCount

ADDED FILES:
============
"@
    
    if ($AddedFiles) {
        $SummaryContent += "`n" + ($AddedFiles -join "`n")
    } else {
        $SummaryContent += "`n(none)"
    }
    
    $SummaryContent += @"

REMOVED FILES:
==============
"@
    
    if ($RemovedFiles) {
        $SummaryContent += "`n" + ($RemovedFiles -join "`n")
    } else {
        $SummaryContent += "`n(none)"
    }
    
    $SummaryContent | Out-File -FilePath $SummaryFile -Encoding UTF8
    
    # Generate file lists
    if ($OldFiles) { $OldFiles | Out-File -FilePath (Join-Path $OutputDir "${ReportPrefix}_old_files.txt") -Encoding UTF8 }
    if ($NewFiles) { $NewFiles | Out-File -FilePath (Join-Path $OutputDir "${ReportPrefix}_new_files.txt") -Encoding UTF8 }
    if ($AddedFiles) { $AddedFiles | Out-File -FilePath (Join-Path $OutputDir "${ReportPrefix}_added_files.txt") -Encoding UTF8 }
    if ($RemovedFiles) { $RemovedFiles | Out-File -FilePath (Join-Path $OutputDir "${ReportPrefix}_removed_files.txt") -Encoding UTF8 }
    
    # Generate detailed diff if not summary only
    if (!$SummaryOnly) {
        Write-Status "Generating detailed diff using Git..."
        
        $DiffFile = Join-Path $OutputDir "${ReportPrefix}_full_diff.txt"
        
        # Use git diff if available
        if (Get-Command git -ErrorAction SilentlyContinue) {
            try {
                $GitOutput = git diff --no-index $OldDir $NewDir 2>$null
                $GitOutput | Out-File -FilePath $DiffFile -Encoding UTF8
            } catch {
                Write-Warning "Git diff failed, generating basic comparison"
            }
        } else {
            Write-Warning "Git not found, install Git for better diff output"
        }
    }
    
    # Display summary
    Write-Success "Diff analysis complete!"
    Write-Host ""
    Write-Host "ðŸ“Š SUMMARY:" -ForegroundColor White
    Write-Host "  Files Added:   $AddedCount" -ForegroundColor Green
    Write-Host "  Files Removed: $RemovedCount" -ForegroundColor Red
    Write-Host "  Files Common:  $CommonCount" -ForegroundColor White
    Write-Host ""
    
    if ($AddedCount -gt 0) {
        Write-Status "New files added:"
        $AddedFiles | Select-Object -First 10 | ForEach-Object { Write-Host "  + $_" -ForegroundColor Green }
        if ($AddedCount -gt 10) {
            Write-Host "  ... and $($AddedCount - 10) more" -ForegroundColor Gray
        }
        Write-Host ""
    }
    
    if ($RemovedCount -gt 0) {
        Write-Warning "Files removed:"
        $RemovedFiles | Select-Object -First 10 | ForEach-Object { Write-Host "  - $_" -ForegroundColor Red }
        if ($RemovedCount -gt 10) {
            Write-Host "  ... and $($RemovedCount - 10) more" -ForegroundColor Gray
        }
        Write-Host ""
    }
    
    # Show output files
    Write-Success "Reports generated in: $OutputDir"
    Write-Host "  ðŸ“„ Summary:     ${ReportPrefix}_summary.txt"
    if (!$SummaryOnly) {
        Write-Host "  ðŸ“„ Full Diff:   ${ReportPrefix}_full_diff.txt"
    }
    Write-Host "  ðŸ“„ File Lists:  ${ReportPrefix}_*_files.txt"
    
    Write-Success "Soulfra Platform diff analysis complete! ðŸš€"
    
} finally {
    # Cleanup
    Write-Status "Cleaning up temporary files..."
    if (Test-Path $TempDir) {
        Remove-Item -Path $TempDir -Recurse -Force
    }
}