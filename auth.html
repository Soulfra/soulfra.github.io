<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Soulfra</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .login-container {
      max-width: 500px;
      width: 100%;
    }

    .login-card {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 16px;
      padding: 40px;
      backdrop-filter: blur(10px);
      text-align: center;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .subtitle {
      opacity: 0.9;
      margin-bottom: 30px;
    }

    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
    }

    .tab-button {
      flex: 1;
      padding: 12px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .tab-button.active {
      background: rgba(255,255,255,0.3);
      border-color: rgba(255,255,255,0.5);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    input, textarea {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 1rem;
    }

    input::placeholder, textarea::placeholder {
      color: rgba(255,255,255,0.5);
    }

    button {
      width: 100%;
      padding: 12px 20px;
      background: #2ecc71;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.2s;
      margin-top: 10px;
    }

    button:hover {
      transform: translateY(-2px);
    }

    button.secondary {
      background: rgba(255,255,255,0.2);
    }

    .status {
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      font-weight: 600;
      display: none;
    }

    .status.success {
      background: rgba(46,204,113,0.3);
      border: 1px solid rgba(46,204,113,0.5);
      display: block;
    }

    .status.error {
      background: rgba(231,76,60,0.3);
      border: 1px solid rgba(231,76,60,0.5);
      display: block;
    }

    .info-box {
      background: rgba(52,152,219,0.2);
      border: 1px solid rgba(52,152,219,0.3);
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      font-size: 0.9rem;
      text-align: left;
    }

    .info-box h4 {
      margin-bottom: 10px;
      color: #3498db;
    }

    .file-upload {
      margin: 20px 0;
      padding: 20px;
      border: 2px dashed rgba(255,255,255,0.3);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .file-upload:hover {
      border-color: rgba(255,255,255,0.5);
      background: rgba(255,255,255,0.05);
    }

    .file-upload input {
      display: none;
    }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="login-card">
      <h1>üîê Login</h1>
      <p class="subtitle">Secure, passwordless authentication</p>

      <div id="statusMessage" class="status"></div>

      <!-- Tab Buttons -->
      <div class="tab-buttons">
        <button class="tab-button active" id="signinBtn">Sign In</button>
        <button class="tab-button" id="createBtn">Create Account</button>
        <button class="tab-button" id="importBtn">Import</button>
      </div>

      <!-- Sign In Tab -->
      <div id="signinTab" class="tab-content active">
        <div class="info-box">
          <h4>‚ú® Auto Login</h4>
          <p>If you've logged in before on this device, click below:</p>
        </div>
        <button onclick="autoLogin()">üöÄ Auto Login</button>
      </div>

      <!-- Create Account Tab -->
      <div id="createTab" class="tab-content">
        <input id="createEmail" type="email" placeholder="Email address" autocomplete="email">
        <input id="createName" type="text" placeholder="Name (optional)" autocomplete="name">

        <div class="info-box">
          <h4>üîí Privacy First</h4>
          <ul style="margin-left: 20px;">
            <li>No password needed</li>
            <li>Ed25519 cryptographic keys</li>
            <li>Keys stored encrypted locally</li>
            <li>You control your identity</li>
          </ul>
        </div>

        <button onclick="createAccount()">‚ú® Create Account</button>
      </div>

      <!-- Import Tab -->
      <div id="importTab" class="tab-content">
        <div class="info-box">
          <h4>üì• Import Identity</h4>
          <p>Upload your identity backup file (JSON)</p>
        </div>

        <label for="identityFile" class="file-upload">
          <div>üìÅ Click to select identity file</div>
          <input id="identityFile" type="file" accept=".json" onchange="importIdentity()">
        </label>

        <p style="font-size: 0.9rem; opacity: 0.8; margin-top: 20px;">
          Or paste your identity JSON:
        </p>
        <textarea id="identityJSON" style="height: 150px; font-family: monospace;" placeholder='{"version":"1.0","userId":"...","publicKey":"...",...}'></textarea>

        <button onclick="importFromText()">üì• Import from Text</button>
      </div>

      <div style="margin-top: 30px; opacity: 0.8;">
        <a href="index.html" style="color: #fff; text-decoration: underline;">‚Üê Back to Home</a>
      </div>
    </div>
  </div>

  <!-- Auth System -->
  <script src="soulfra-universal-auth.js"></script>
  <script src="sheets-qr-auth.js"></script>
  <script src="soulfra-unified-auth.js"></script>

  <script>
    let unifiedAuth = null;

    // Initialize on page load
    window.addEventListener('load', () => {
      unifiedAuth = new SoulfraUnifiedAuth();
      console.log('[Login] Unified auth initialized');

      // Setup tab buttons
      document.getElementById('signinBtn').onclick = () => switchTab('signin');
      document.getElementById('createBtn').onclick = () => switchTab('create');
      document.getElementById('importBtn').onclick = () => switchTab('import');
    });

    // Switch tabs
    function switchTab(tab) {
      // Update buttons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(tab + 'Btn').classList.add('active');

      // Update content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tab + 'Tab').classList.add('active');

      // Clear status
      hideStatus();
    }

    // Auto login (if identity exists)
    async function autoLogin() {
      try {
        showStatus('Logging in...', 'success');

        const result = await unifiedAuth.login();

        if (!result.success) {
          if (result.reason === 'no_identity') {
            showStatus('No saved identity found. Please create an account or import.', 'error');
          } else if (result.reason === 'session_expired') {
            showStatus('Session expired (30 days). Please create a new account or import.', 'error');
          } else {
            showStatus('Login failed: ' + (result.error || result.reason), 'error');
          }
          return;
        }

        showStatus(`‚úì Welcome back, ${result.user.name || result.user.email || 'User'}!`, 'success');

        // Redirect to original page or dashboard
        const urlParams = new URLSearchParams(window.location.search);
        const redirect = urlParams.get('redirect') || 'index.html';

        setTimeout(() => {
          window.location.href = redirect;
        }, 1500);

      } catch (error) {
        console.error('[Login] Auto login error:', error);
        showStatus('Login error: ' + error.message, 'error');
      }
    }

    // Create new account
    async function createAccount() {
      try {
        const email = document.getElementById('createEmail').value.trim();
        const name = document.getElementById('createName').value.trim();

        if (!email) {
          showStatus('Please enter your email', 'error');
          return;
        }

        showStatus('Creating account...', 'success');

        const result = await unifiedAuth.createIdentity(email, name);

        if (!result.success) {
          showStatus('Failed to create account: ' + result.error, 'error');
          return;
        }

        showStatus(`‚úì Account created! User ID: ${result.userId.substring(0, 8)}...`, 'success');

        // Offer to download backup
        if (confirm('Would you like to download a backup of your identity? (Recommended)')) {
          downloadIdentity();
        }

        // Redirect after success
        const urlParams = new URLSearchParams(window.location.search);
        const redirect = urlParams.get('redirect') || 'index.html';

        setTimeout(() => {
          window.location.href = redirect;
        }, 2000);

      } catch (error) {
        console.error('[Login] Create account error:', error);
        showStatus('Error: ' + error.message, 'error');
      }
    }

    // Import identity from file
    async function importIdentity() {
      try {
        const file = document.getElementById('identityFile').files[0];

        if (!file) {
          return;
        }

        showStatus('Importing identity...', 'success');

        const text = await file.text();

        const result = await unifiedAuth.importIdentity(text);

        if (!result.success) {
          showStatus('Import failed: ' + result.error, 'error');
          return;
        }

        showStatus(`‚úì Identity imported! User ID: ${result.userId.substring(0, 8)}...`, 'success');

        // Redirect after success
        const urlParams = new URLSearchParams(window.location.search);
        const redirect = urlParams.get('redirect') || 'index.html';

        setTimeout(() => {
          window.location.href = redirect;
        }, 2000);

      } catch (error) {
        console.error('[Login] Import error:', error);
        showStatus('Import error: ' + error.message, 'error');
      }
    }

    // Import identity from text
    async function importFromText() {
      try {
        const text = document.getElementById('identityJSON').value.trim();

        if (!text) {
          showStatus('Please paste your identity JSON', 'error');
          return;
        }

        showStatus('Importing identity...', 'success');

        const result = await unifiedAuth.importIdentity(text);

        if (!result.success) {
          showStatus('Import failed: ' + result.error, 'error');
          return;
        }

        showStatus(`‚úì Identity imported! User ID: ${result.userId.substring(0, 8)}...`, 'success');

        // Redirect after success
        const urlParams = new URLSearchParams(window.location.search);
        const redirect = urlParams.get('redirect') || 'index.html';

        setTimeout(() => {
          window.location.href = redirect;
        }, 2000);

      } catch (error) {
        console.error('[Login] Import error:', error);
        showStatus('Import error: ' + error.message, 'error');
      }
    }

    // Download identity backup
    function downloadIdentity() {
      try {
        const identity = unifiedAuth.exportIdentity();

        const blob = new Blob([identity], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `soulfra-identity-${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        URL.revokeObjectURL(url);

        showStatus('‚úì Identity backup downloaded', 'success');

      } catch (error) {
        console.error('[Login] Download error:', error);
        showStatus('Download error: ' + error.message, 'error');
      }
    }

    // Show status message
    function showStatus(message, type) {
      const statusEl = document.getElementById('statusMessage');
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
    }

    // Hide status message
    function hideStatus() {
      const statusEl = document.getElementById('statusMessage');
      statusEl.style.display = 'none';
    }
  </script>
</body>
</html>
