<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Accountability - CalOS</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .card {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 16px;
      padding: 30px;
      backdrop-filter: blur(10px);
      margin-bottom: 20px;
    }

    h1 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .subtitle {
      opacity: 0.9;
      margin-bottom: 30px;
    }

    .streak-box {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      margin-bottom: 30px;
    }

    .streak-number {
      font-size: 4rem;
      font-weight: bold;
      line-height: 1;
    }

    .streak-label {
      font-size: 1.2rem;
      opacity: 0.9;
      margin-top: 10px;
    }

    .folders-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .folder-card {
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: transform 0.2s, background 0.2s;
    }

    .folder-card:hover {
      transform: translateY(-4px);
      background: rgba(0,0,0,0.4);
    }

    .folder-icon {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .folder-name {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .folder-count {
      font-size: 2rem;
      font-weight: bold;
      color: #2ecc71;
    }

    .folder-items {
      display: none;
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
    }

    .folder-items.active {
      display: block;
    }

    .folder-item {
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }

    .item-subject {
      font-weight: 600;
      margin-bottom: 5px;
    }

    .item-body {
      font-size: 0.9rem;
      opacity: 0.8;
      white-space: pre-wrap;
      max-height: 100px;
      overflow: hidden;
    }

    .item-time {
      font-size: 0.8rem;
      opacity: 0.6;
      margin-top: 5px;
    }

    button {
      padding: 12px 24px;
      background: #2ecc71;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      margin: 5px;
      transition: transform 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
    }

    button.secondary {
      background: rgba(255,255,255,0.2);
    }

    button.danger {
      background: #e74c3c;
    }

    .status {
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      font-weight: 600;
      display: none;
    }

    .status.success {
      background: rgba(46,204,113,0.3);
      border: 1px solid rgba(46,204,113,0.5);
      display: block;
    }

    .status.error {
      background: rgba(231,76,60,0.3);
      border: 1px solid rgba(231,76,60,0.5);
      display: block;
    }

    .blog-preview {
      background: rgba(255,255,255,0.95);
      color: #333;
      border-radius: 12px;
      padding: 30px;
      margin: 20px 0;
      max-height: 600px;
      overflow-y: auto;
    }

    .blog-preview h1 {
      color: #333;
      margin-bottom: 20px;
    }

    .blog-preview h2 {
      color: #333;
      margin-top: 30px;
      border-bottom: 2px solid #eee;
      padding-bottom: 10px;
    }

    .blog-preview pre {
      background: #f4f4f4;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      color: #333;
    }

    .blog-preview code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      color: #333;
    }

    .info-box {
      background: rgba(52,152,219,0.2);
      border: 1px solid rgba(52,152,219,0.3);
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      font-size: 0.9rem;
    }

    .info-box h4 {
      margin-bottom: 10px;
      color: #3498db;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>üìß Daily Accountability</h1>
      <p class="subtitle">Email yourself daily ‚Ä¢ Auto-file responses ‚Ä¢ Generate blog posts</p>

      <div id="statusMessage" class="status"></div>

      <!-- Streak Display -->
      <div class="streak-box">
        <div class="streak-number" id="streakNumber">0</div>
        <div class="streak-label">Day Streak üî•</div>
        <div style="margin-top: 10px; opacity: 0.9;">
          <span id="totalCheckins">0</span> total check-ins
        </div>
      </div>

      <!-- Email Schedule Info -->
      <div class="info-box">
        <h4>üì¨ Email Schedule</h4>
        <p><strong>Morning (9am):</strong> "What are you building today?"</p>
        <p><strong>Evening (9pm):</strong> "What did you ship today?"</p>
        <p style="margin-top: 10px; opacity: 0.8;">Just reply to the emails and I'll auto-file your responses into folders below.</p>
      </div>

      <!-- Folders -->
      <h2 style="margin: 30px 0 20px 0;">üìÅ Your Folders</h2>

      <div class="folders-grid">
        <div class="folder-card" onclick="toggleFolder('wins')">
          <div class="folder-icon">üéØ</div>
          <div class="folder-name">Wins</div>
          <div class="folder-count" id="winsCount">0</div>
        </div>

        <div class="folder-card" onclick="toggleFolder('code')">
          <div class="folder-icon">üíª</div>
          <div class="folder-name">Code</div>
          <div class="folder-count" id="codeCount">0</div>
        </div>

        <div class="folder-card" onclick="toggleFolder('ideas')">
          <div class="folder-icon">üí°</div>
          <div class="folder-name">Ideas</div>
          <div class="folder-count" id="ideasCount">0</div>
        </div>

        <div class="folder-card" onclick="toggleFolder('todos')">
          <div class="folder-icon">‚úÖ</div>
          <div class="folder-name">TODOs</div>
          <div class="folder-count" id="todosCount">0</div>
        </div>
      </div>

      <!-- Folder Contents -->
      <div id="winsItems" class="folder-items"></div>
      <div id="codeItems" class="folder-items"></div>
      <div id="ideasItems" class="folder-items"></div>
      <div id="todosItems" class="folder-items"></div>
    </div>

    <!-- Blog Generation -->
    <div class="card">
      <h2>üìù Weekly Blog</h2>
      <p class="subtitle">Turn your check-ins into a public portfolio</p>

      <div>
        <button onclick="generateBlog()">‚ú® Generate This Week's Blog Post</button>
        <button class="secondary" onclick="viewPosts()">üìö View Past Posts</button>
      </div>

      <div id="blogPreview"></div>

      <div id="blogActions" style="display: none; margin-top: 20px;">
        <button onclick="downloadBlog()">üíæ Download HTML</button>
        <button onclick="publishBlog()">üöÄ Publish to GitHub Pages</button>
        <button class="secondary" onclick="closeBlogPreview()">‚úï Close</button>
      </div>
    </div>

    <div style="text-align: center; margin-top: 30px;">
      <a href="index.html" style="color: #fff; text-decoration: underline;">‚Üê Back to Home</a>
    </div>
  </div>

  <!-- Auth System -->
  <script src="soulfra-universal-auth.js"></script>
  <script src="sheets-qr-auth.js"></script>
  <script src="soulfra-unified-auth.js"></script>

  <!-- Accountability System -->
  <script src="lib/daily-accountability.js"></script>
  <script src="lib/email-filer.js"></script>
  <script src="lib/weekly-blog.js"></script>

  <script>
    let unifiedAuth = null;
    let accountability = null;
    let filer = null;
    let blog = null;
    let currentUser = null;
    let currentBlogPost = null;

    // Initialize on load
    window.addEventListener('load', async () => {
      await initAuth();
      await loadDashboard();
    });

    // Initialize auth
    async function initAuth() {
      try {
        unifiedAuth = new SoulfraUnifiedAuth();

        const result = await unifiedAuth.login();

        if (!result.success) {
          showStatus('Please login first', 'error');
          setTimeout(() => {
            window.location.href = 'auth.html?redirect=daily-accountability.html';
          }, 2000);
          return;
        }

        currentUser = result.user;

        // Initialize systems
        const sheetsAuth = {
          spreadsheetId: 'YOUR_SPREADSHEET_ID', // TODO: Replace with actual ID
          apiKey: 'YOUR_API_KEY' // TODO: Replace with actual key
        };

        accountability = new DailyAccountability(null, sheetsAuth); // Gmail relay TODO
        filer = new EmailFiler(sheetsAuth);
        blog = new WeeklyBlog(filer, sheetsAuth);

        // Initialize tables
        await accountability.initTables();
        await filer.initTables();
        await blog.initTable();

        console.log('[Dashboard] Initialized for:', currentUser.email);

      } catch (error) {
        console.error('[Dashboard] Init error:', error);
        showStatus('Initialization failed: ' + error.message, 'error');
      }
    }

    // Load dashboard data
    async function loadDashboard() {
      try {
        if (!currentUser || !accountability || !filer) {
          return;
        }

        // Load streak
        const streakData = await accountability.getStreak(currentUser.userId);
        document.getElementById('streakNumber').textContent = streakData.streak;
        document.getElementById('totalCheckins').textContent = streakData.total;

        // Load folder stats
        const stats = await filer.getFolderStats(currentUser.userId);

        if (stats) {
          document.getElementById('winsCount').textContent = stats.wins?.count || 0;
          document.getElementById('codeCount').textContent = stats.code?.count || 0;
          document.getElementById('ideasCount').textContent = stats.ideas?.count || 0;
          document.getElementById('todosCount').textContent = stats.todos?.count || 0;
        }

        console.log('[Dashboard] Data loaded');

      } catch (error) {
        console.error('[Dashboard] Load error:', error);
        showStatus('Failed to load data: ' + error.message, 'error');
      }
    }

    // Toggle folder view
    async function toggleFolder(category) {
      const itemsDiv = document.getElementById(category + 'Items');

      if (itemsDiv.classList.contains('active')) {
        itemsDiv.classList.remove('active');
        return;
      }

      // Close other folders
      document.querySelectorAll('.folder-items').forEach(div => {
        div.classList.remove('active');
      });

      // Load items
      const items = await filer.getFolder(currentUser.userId, category);

      // Render items
      itemsDiv.innerHTML = items.map(item => `
        <div class="folder-item">
          <div class="item-subject">${item.subject || 'No subject'}</div>
          <div class="item-body">${item.body}</div>
          <div class="item-time">${new Date(item.timestamp).toLocaleString()}</div>
        </div>
      `).join('');

      itemsDiv.classList.add('active');
    }

    // Generate blog post
    async function generateBlog() {
      try {
        showStatus('Generating blog post...', 'success');

        const result = await blog.generatePost(currentUser.userId, {
          days: 7,
          includeCode: true,
          includeIdeas: false,
          autoPublish: false
        });

        if (!result.success) {
          throw new Error(result.error);
        }

        currentBlogPost = result.post;

        // Render preview
        const previewDiv = document.getElementById('blogPreview');
        previewDiv.className = 'blog-preview';
        previewDiv.innerHTML = markdownToHTML(result.post.body);

        document.getElementById('blogActions').style.display = 'block';

        showStatus('‚úì Blog post generated!', 'success');

      } catch (error) {
        console.error('[Dashboard] Generate blog error:', error);
        showStatus('Failed to generate blog: ' + error.message, 'error');
      }
    }

    // Download blog as HTML
    function downloadBlog() {
      if (!currentBlogPost) return;

      const html = blog.exportAsHTML(currentBlogPost);
      const blob = new Blob([html], { type: 'text/html' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = `blog-${Date.now()}.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      URL.revokeObjectURL(url);

      showStatus('‚úì Blog downloaded!', 'success');
    }

    // Publish blog
    async function publishBlog() {
      try {
        if (!currentBlogPost) return;

        showStatus('Publishing...', 'success');

        const result = await blog.publishPost(currentUser.userId, currentBlogPost.createdAt);

        if (!result.success) {
          throw new Error(result.error);
        }

        showStatus('‚úì Blog published!', 'success');

      } catch (error) {
        console.error('[Dashboard] Publish error:', error);
        showStatus('Failed to publish: ' + error.message, 'error');
      }
    }

    // Close blog preview
    function closeBlogPreview() {
      document.getElementById('blogPreview').innerHTML = '';
      document.getElementById('blogActions').style.display = 'none';
      currentBlogPost = null;
    }

    // View past posts
    async function viewPosts() {
      try {
        const posts = await blog.getPosts(currentUser.userId);

        if (posts.length === 0) {
          showStatus('No posts yet. Generate your first one!', 'error');
          return;
        }

        const previewDiv = document.getElementById('blogPreview');
        previewDiv.className = 'blog-preview';
        previewDiv.innerHTML = `
          <h2>üìö Past Posts</h2>
          ${posts.map(post => `
            <div style="padding: 15px; background: #f9f9f9; margin: 10px 0; border-radius: 8px;">
              <h3>${post.title}</h3>
              <p style="opacity: 0.7; font-size: 0.9rem;">
                ${new Date(post.createdAt).toLocaleDateString()}
                ${post.published ? '‚Ä¢ Published ‚úì' : '‚Ä¢ Draft'}
              </p>
            </div>
          `).join('')}
        `;

      } catch (error) {
        console.error('[Dashboard] View posts error:', error);
        showStatus('Failed to load posts: ' + error.message, 'error');
      }
    }

    // Simple markdown to HTML
    function markdownToHTML(md) {
      return md
        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
        .replace(/`(.*?)`/g, '<code>$1</code>')
        .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>')
        .replace(/^- (.*$)/gim, '<li>$1</li>')
        .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
        .replace(/^\n/gim, '<br>')
        .replace(/---/g, '<hr>');
    }

    // Show status message
    function showStatus(message, type) {
      const statusEl = document.getElementById('statusMessage');
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;

      if (type === 'success') {
        setTimeout(() => {
          statusEl.style.display = 'none';
        }, 3000);
      }
    }
  </script>
</body>
</html>
