name: Provision DNS Records

on:
  push:
    branches: [main, master]
    paths:
      - 'domains/*.json'
  workflow_dispatch:
    inputs:
      domain_file:
        description: 'Domain file to provision (e.g., alice.json)'
        required: false

permissions:
  contents: write
  issues: write

jobs:
  provision:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need history to detect changes

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Provision DNS records
        id: provision
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_IDS: ${{ secrets.CLOUDFLARE_ZONE_IDS }}
        run: |
          python3 << 'EOF'
          import json
          import os
          import sys
          import requests
          from pathlib import Path
          from typing import Dict, List, Optional

          # CloudFlare API configuration
          CF_API_TOKEN = os.getenv('CLOUDFLARE_API_TOKEN')
          CF_ZONE_IDS_JSON = os.getenv('CLOUDFLARE_ZONE_IDS', '{}')

          # Parse zone IDs (format: {"soulfra": "zone_id", "calriven": "zone_id", ...})
          try:
              CF_ZONE_IDS = json.loads(CF_ZONE_IDS_JSON)
          except:
              CF_ZONE_IDS = {}

          class CloudFlareAPI:
              """CloudFlare API client for DNS management"""

              def __init__(self, api_token: str):
                  self.api_token = api_token
                  self.base_url = "https://api.cloudflare.com/client/v4"
                  self.headers = {
                      "Authorization": f"Bearer {api_token}",
                      "Content-Type": "application/json"
                  }

              def list_dns_records(self, zone_id: str, name: str = None) -> List[Dict]:
                  """List DNS records for a zone"""
                  url = f"{self.base_url}/zones/{zone_id}/dns_records"
                  params = {}
                  if name:
                      params['name'] = name

                  response = requests.get(url, headers=self.headers, params=params)
                  response.raise_for_status()
                  return response.json().get('result', [])

              def create_dns_record(self, zone_id: str, record_type: str, name: str, content: str, proxied: bool = True) -> Dict:
                  """Create a DNS record"""
                  url = f"{self.base_url}/zones/{zone_id}/dns_records"
                  data = {
                      "type": record_type,
                      "name": name,
                      "content": content,
                      "ttl": 1,  # Auto (CloudFlare proxy)
                      "proxied": proxied
                  }

                  response = requests.post(url, headers=self.headers, json=data)
                  response.raise_for_status()
                  return response.json().get('result', {})

              def update_dns_record(self, zone_id: str, record_id: str, record_type: str, name: str, content: str, proxied: bool = True) -> Dict:
                  """Update an existing DNS record"""
                  url = f"{self.base_url}/zones/{zone_id}/dns_records/{record_id}"
                  data = {
                      "type": record_type,
                      "name": name,
                      "content": content,
                      "ttl": 1,
                      "proxied": proxied
                  }

                  response = requests.put(url, headers=self.headers, json=data)
                  response.raise_for_status()
                  return response.json().get('result', {})

              def delete_dns_record(self, zone_id: str, record_id: str) -> bool:
                  """Delete a DNS record"""
                  url = f"{self.base_url}/zones/{zone_id}/dns_records/{record_id}"
                  response = requests.delete(url, headers=self.headers)
                  response.raise_for_status()
                  return True

          def get_changed_domain_files() -> List[str]:
              """Get list of changed domain files"""
              import subprocess

              try:
                  # Get changed files from last commit
                  result = subprocess.run(
                      ['git', 'diff', '--name-only', 'HEAD~1', 'HEAD'],
                      capture_output=True,
                      text=True,
                      check=True
                  )
                  files = result.stdout.strip().split('\n')
                  return [f for f in files if f.startswith('domains/') and f.endswith('.json')]
              except:
                  # Fallback: process all domain files
                  return [str(f) for f in Path('domains').glob('*.json')]

          def provision_domain(cf: CloudFlareAPI, domain_file: str) -> bool:
              """Provision DNS for a domain file"""
              print(f"\n{'='*70}")
              print(f"ðŸ“‹ Processing: {domain_file}")
              print('='*70)

              # Load domain configuration
              try:
                  with open(domain_file) as f:
                      config = json.load(f)
              except Exception as e:
                  print(f"âŒ Failed to load {domain_file}: {e}")
                  return False

              # Extract configuration
              owner = config.get('owner')
              subdomain = config.get('subdomain')
              domain = config.get('domain')
              target = config.get('target')
              record_type = config.get('record_type')

              if not all([owner, subdomain, domain, target, record_type]):
                  print(f"âŒ Missing required fields in {domain_file}")
                  return False

              # Get CloudFlare zone ID
              zone_id = CF_ZONE_IDS.get(domain)
              if not zone_id:
                  print(f"âš ï¸  No CloudFlare zone ID configured for {domain}.com")
                  print(f"   Set CLOUDFLARE_ZONE_IDS secret with zone ID for {domain}")
                  return False

              # Construct full domain name
              full_domain = f"{subdomain}.{domain}.com"

              print(f"ðŸŒ Domain: {full_domain}")
              print(f"ðŸŽ¯ Target: {target}")
              print(f"ðŸ“ Type: {record_type}")

              try:
                  # Check if record already exists
                  existing_records = cf.list_dns_records(zone_id, name=full_domain)

                  if existing_records:
                      # Update existing record
                      record = existing_records[0]
                      record_id = record['id']
                      print(f"ðŸ”„ Updating existing DNS record (ID: {record_id})")

                      # Determine if record should be proxied (only for CNAME/A records)
                      proxied = record_type in ['CNAME', 'A']

                      cf.update_dns_record(zone_id, record_id, record_type, full_domain, target, proxied)
                      print(f"âœ… Updated {full_domain} â†’ {target}")

                  else:
                      # Create new record
                      print(f"âž• Creating new DNS record")

                      # Determine if record should be proxied
                      proxied = record_type in ['CNAME', 'A']

                      cf.create_dns_record(zone_id, record_type, full_domain, target, proxied)
                      print(f"âœ… Created {full_domain} â†’ {target}")

                  # Update domain file with provisioning status
                  config['status'] = 'active'
                  config['dns_configured'] = True
                  config['verified'] = True

                  with open(domain_file, 'w') as f:
                      json.dump(config, f, indent=2)

                  print(f"âœ… DNS provisioning complete for {full_domain}")
                  return True

              except requests.exceptions.HTTPError as e:
                  print(f"âŒ CloudFlare API error: {e}")
                  print(f"   Response: {e.response.text if hasattr(e, 'response') else 'N/A'}")
                  return False
              except Exception as e:
                  print(f"âŒ Unexpected error: {e}")
                  return False

          def main():
              """Main provisioning function"""
              print("=" * 70)
              print("ðŸš€ Soulfra DNS Provisioning System")
              print("=" * 70)

              # Check if CloudFlare credentials are configured
              if not CF_API_TOKEN:
                  print("\nâš ï¸  WARNING: CLOUDFLARE_API_TOKEN not configured")
                  print("   DNS records will NOT be provisioned")
                  print("   Please add CLOUDFLARE_API_TOKEN to GitHub Secrets")
                  print("\nValidation complete. Skipping DNS provisioning.")
                  return

              if not CF_ZONE_IDS:
                  print("\nâš ï¸  WARNING: CLOUDFLARE_ZONE_IDS not configured")
                  print("   DNS records will NOT be provisioned")
                  print("   Please add CLOUDFLARE_ZONE_IDS to GitHub Secrets")
                  print("   Format: {\"soulfra\": \"zone_id\", \"calriven\": \"zone_id\", ...}")
                  print("\nValidation complete. Skipping DNS provisioning.")
                  return

              # Initialize CloudFlare API
              cf = CloudFlareAPI(CF_API_TOKEN)

              # Get changed domain files
              domain_files = get_changed_domain_files()

              if not domain_files:
                  print("\nðŸ“­ No domain files changed. Nothing to provision.")
                  return

              print(f"\nðŸ“¦ Found {len(domain_files)} domain file(s) to process:\n")
              for f in domain_files:
                  print(f"   - {f}")

              # Provision each domain
              results = []
              for domain_file in domain_files:
                  success = provision_domain(cf, domain_file)
                  results.append((domain_file, success))

              # Summary
              print("\n" + "=" * 70)
              print("ðŸ“Š PROVISIONING SUMMARY")
              print("=" * 70)

              successful = sum(1 for _, success in results if success)
              failed = len(results) - successful

              print(f"\nâœ… Successful: {successful}")
              print(f"âŒ Failed: {failed}")

              if failed > 0:
                  print("\nâŒ Failed domains:")
                  for domain_file, success in results:
                      if not success:
                          print(f"   - {domain_file}")
                  sys.exit(1)
              else:
                  print("\nðŸŽ‰ All domains provisioned successfully!")

          if __name__ == '__main__':
              main()
          EOF

      - name: Commit DNS configuration updates
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add domains/*.json
          git diff --staged --quiet || git commit -m "ðŸ¤– Update DNS configuration status"
          git push

      - name: Create deployment summary
        if: always()
        run: |
          echo "## ðŸŒ DNS Provisioning Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for detailed information about DNS record provisioning." >> $GITHUB_STEP_SUMMARY
