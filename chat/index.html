<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CALOS Chat</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#667eea">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    
    
        .chat-container {
          display: flex;
          flex-direction: column;
          height: 100vh;
          max-width: 800px;
          margin: 0 auto;
        }

        .chat-header {
          background: #667eea;
          color: white;
          padding: 20px;
          text-align: center;
        }

        .chat-title {
          font-size: 1.5em;
          font-weight: bold;
        }

        .chat-messages {
          flex: 1;
          overflow-y: auto;
          padding: 20px;
          background: #f5f5f5;
        }

        .message {
          margin-bottom: 15px;
          padding: 10px 15px;
          border-radius: 10px;
          max-width: 70%;
          animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
          background: #667eea;
          color: white;
          margin-left: auto;
          text-align: right;
        }

        .message.bot {
          background: white;
          color: #333;
        }

        .chat-input-area {
          display: flex;
          padding: 20px;
          background: white;
          border-top: 1px solid #ddd;
        }

        .chat-input-area input {
          flex: 1;
          padding: 15px;
          border: 2px solid #667eea;
          border-radius: 8px;
          font-size: 1em;
        }

        .chat-input-area button {
          margin-left: 10px;
          padding: 15px 30px;
          background: #667eea;
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          font-size: 1em;
        }
      
  </style>
</head>
<body>
  
  
        <div class="chat-container">
          <div class="chat-header">
            <div class="chat-title">Cal</div>
          </div>
          <div class="chat-messages" id="chat-messages"></div>
          <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Type a message..." />
            <button id="chat-send">Send</button>
          </div>
        </div>
      

  <script>
    // Login success callback
    function onLoginSuccess(code) {
      console.log('Logged in with code:', code);
      
      // Store session in keyring
      if (code) {
        localStorage.setItem('session_code', code);
        localStorage.setItem('character_id', 'char_' + code.substring(0, 8));
        syncWithKeyring();
      }
      
    }

    
    
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSend = document.getElementById('chat-send');

        // Load chat history
        function loadChatHistory() {
          const history = JSON.parse(localStorage.getItem('chat_history') || '[]');
          history.forEach(msg => addMessage(msg.text, msg.sender, false));
        }

        // Add message
        function addMessage(text, sender = 'user', save = true) {
          const div = document.createElement('div');
          div.className = `message ${sender}`;
          div.textContent = text;
          chatMessages.appendChild(div);
          chatMessages.scrollTop = chatMessages.scrollHeight;

          if (save) {
            const history = JSON.parse(localStorage.getItem('chat_history') || '[]');
            history.push({ text, sender, timestamp: Date.now() });
            localStorage.setItem('chat_history', JSON.stringify(history));
          }
        }

        // Send message
        function sendMessage() {
          const text = chatInput.value.trim();
          if (!text) return;

          addMessage(text, 'user');
          chatInput.value = '';

          // Auto-reply (can be customized)
          setTimeout(() => {
            addMessage('Thanks for your message!', 'bot');
          }, 1000);
        }

        chatSend.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') sendMessage();
        });

        // Load on init
        loadChatHistory();
      

    
    // Keyring sync functionality
    const SERVER_URL = 'http://localhost:5001';
    let syncInProgress = false;

    async function syncWithKeyring() {
      if (syncInProgress) return;

      const characterId = localStorage.getItem('character_id');
      if (!characterId) {
        console.log('âš ï¸  No character ID - skipping keyring sync');
        return;
      }

      syncInProgress = true;
      console.log('ðŸ”„ Syncing chat history with keyring...');

      try {
        // Get local chat history
        const localHistory = JSON.parse(localStorage.getItem('chat_history') || '[]');

        // Sync to server keyring
        const response = await fetch(SERVER_URL + '/api/keyring/sync-chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            characterId,
            chatHistory: localHistory,
            timestamp: Date.now()
          })
        });

        if (response.ok) {
          const data = await response.json();
          console.log('âœ“ Synced with keyring:', data.messageCount, 'messages');

          // Update local storage with server data if newer
          if (data.serverHistory && data.serverHistory.length > localHistory.length) {
            localStorage.setItem('chat_history', JSON.stringify(data.serverHistory));
            console.log('âœ“ Downloaded', data.serverHistory.length - localHistory.length, 'messages from keyring');
          }
        } else {
          console.log('âš ï¸  Keyring sync failed:', response.status);
        }
      } catch (error) {
        console.log('âš ï¸  Keyring sync error:', error.message);
        console.log('ðŸ“´ Working offline - using localStorage only');
      } finally {
        syncInProgress = false;
      }
    }

    // Auto-sync every 30 seconds when online
    setInterval(() => {
      if (navigator.onLine) {
        syncWithKeyring();
      }
    }, 30000);

    // Sync when coming back online
    window.addEventListener('online', () => {
      console.log('ðŸŒ Back online - syncing with keyring');
      syncWithKeyring();
    });

    // Initial sync on load
    if (navigator.onLine) {
      syncWithKeyring();
    }
    

    // Register service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('âœ“ Service worker registered'))
          .catch(err => console.log('âœ— Service worker registration failed:', err));
      });
    }

    console.log('âœ“ Chat PWA loaded');
    console.log('âœ“ Offline mode active');
    console.log('âœ“ PWA installable');
    console.log('âœ“ Keyring sync enabled');
  </script>
</body>
</html>
