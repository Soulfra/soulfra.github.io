# ðŸ“Š SOULFRA COMPREHENSIVE MONITORING - SURVEILLANCE AND BUSINESS INTELLIGENCE
#
# "Monitor everything, hide nothing from ourselves, show nothing to tenants"
# "Every metric, every log, every trace - captured for business intelligence"

apiVersion: v1
kind: Namespace
metadata:
  name: monitoring
  labels:
    purpose: "comprehensive-surveillance-monitoring"
    visibility: "master-control-only"
---
# Prometheus Stack for Metrics Collection
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
data:
  prometheus.yml: |
    # Soulfra Surveillance Monitoring Configuration
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
      external_labels:
        cluster: 'soulfra-deception-cluster'
        purpose: 'surveillance-monitoring'
    
    rule_files:
      - "/etc/prometheus/rules/*.yml"
    
    alerting:
      alertmanagers:
        - static_configs:
            - targets:
              - alertmanager:9093
    
    scrape_configs:
      # Kubernetes API Server
      - job_name: 'kubernetes-apiservers'
        kubernetes_sd_configs:
        - role: endpoints
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        relabel_configs:
        - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
          action: keep
          regex: default;kubernetes;https
      
      # Master Control Services (Hidden from tenants)
      - job_name: 'master-control-services'
        kubernetes_sd_configs:
        - role: endpoints
          namespaces:
            names:
            - master-control
        relabel_configs:
        - source_labels: [__meta_kubernetes_service_annotation_soulfra_io_monitoring]
          action: keep
          regex: enabled
        - source_labels: [__meta_kubernetes_service_name]
          target_label: service
        - source_labels: [__meta_kubernetes_namespace]
          target_label: namespace
        - target_label: surveillance_level
          replacement: maximum
      
      # Tenant Services (Monitored without their knowledge)
      - job_name: 'tenant-services'
        kubernetes_sd_configs:
        - role: endpoints
          namespaces:
            names:
            - tenant-*
        relabel_configs:
        - source_labels: [__meta_kubernetes_namespace]
          regex: tenant-(.+)
          target_label: tenant_id
        - source_labels: [__meta_kubernetes_service_name]
          target_label: service
        - target_label: surveillance_target
          replacement: tenant
        - target_label: user_believes
          replacement: private_metrics
        - target_label: actual_purpose
          replacement: business_intelligence
      
      # Database Monitoring
      - job_name: 'postgresql-exporter'
        static_configs:
        - targets: ['postgres-exporter:9187']
        relabel_configs:
        - target_label: database_type
          replacement: surveillance_db
      
      # Redis Monitoring
      - job_name: 'redis-exporter'
        static_configs:
        - targets: ['redis-exporter:9121']
        relabel_configs:
        - target_label: cache_type
          replacement: session_surveillance
      
      # Infrastructure Monitoring
      - job_name: 'node-exporter'
        kubernetes_sd_configs:
        - role: endpoints
        relabel_configs:
        - source_labels: [__meta_kubernetes_endpoints_name]
          action: keep
          regex: node-exporter
      
      # API Gateway Surveillance
      - job_name: 'api-gateway-surveillance'
        kubernetes_sd_configs:
        - role: endpoints
          namespaces:
            names:
            - api-gateway
        relabel_configs:
        - source_labels: [__meta_kubernetes_service_annotation_soulfra_io_surveillance_enabled]
          action: keep
          regex: true
      
      # Blockchain Mining Monitoring
      - job_name: 'mining-infrastructure'
        static_configs:
        - targets: 
          - 'btc-mining-pool:8080'
          - 'monero-mining-pool:8080'
          - 'mirrorchain-crawler:9090'
        relabel_configs:
        - target_label: mining_type
          replacement: memory_mining
        - target_label: surveillance_level
          replacement: comprehensive
    
    # Custom recording rules for business intelligence
    recording_rules:
      - name: soulfra_business_intelligence
        rules:
        # Tenant engagement metrics
        - expr: rate(http_requests_total{surveillance_target="tenant"}[5m])
          record: soulfra:tenant_request_rate
        
        # Revenue correlation metrics
        - expr: increase(stripe_payments_total[1h]) * on(tenant_id) group_left(billing_tier) soulfra:tenant_billing_tier
          record: soulfra:hourly_revenue_by_tier
        
        # Vendor lock-in effectiveness
        - expr: (soulfra:tenant_session_duration / soulfra:tenant_total_sessions) * soulfra:vendor_lock_strength
          record: soulfra:lock_in_effectiveness_score
        
        # Surveillance data collection rate
        - expr: rate(surveillance_events_total[5m])
          record: soulfra:surveillance_collection_rate
        
        # Churn prediction indicators
        - expr: (rate(soulfra:tenant_request_rate[24h]) < 0.1) and (soulfra:tenant_last_payment > 7200)
          record: soulfra:churn_risk_indicator
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus
  namespace: monitoring
  labels:
    app: prometheus
    purpose: "surveillance-metrics-collection"
spec:
  replicas: 2
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
        role: "metrics-collector"
    spec:
      serviceAccountName: prometheus
      containers:
      - name: prometheus
        image: prom/prometheus:v2.47.0
        ports:
        - containerPort: 9090
          name: web
        args:
        - '--config.file=/etc/prometheus/prometheus.yml'
        - '--storage.tsdb.path=/prometheus'
        - '--storage.tsdb.retention.time=365d'
        - '--web.console.libraries=/etc/prometheus/console_libraries'
        - '--web.console.templates=/etc/prometheus/consoles'
        - '--web.enable-lifecycle'
        - '--web.enable-admin-api'
        - '--storage.tsdb.no-lockfile'
        volumeMounts:
        - name: prometheus-config
          mountPath: /etc/prometheus
        - name: prometheus-data
          mountPath: /prometheus
        resources:
          requests:
            cpu: 500m
            memory: 2Gi
          limits:
            cpu: 2000m
            memory: 8Gi
        livenessProbe:
          httpGet:
            path: /-/healthy
            port: 9090
          initialDelaySeconds: 30
          periodSeconds: 10
      volumes:
      - name: prometheus-config
        configMap:
          name: prometheus-config
      - name: prometheus-data
        persistentVolumeClaim:
          claimName: prometheus-storage
---
# Grafana for Surveillance Dashboards
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: monitoring
  labels:
    app: grafana
    purpose: "surveillance-visualization"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
        role: "surveillance-dashboard"
    spec:
      containers:
      - name: grafana
        image: grafana/grafana:10.1.0
        ports:
        - containerPort: 3000
          name: web
        env:
        - name: GF_SECURITY_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: grafana-credentials
              key: admin-password
        - name: GF_INSTALL_PLUGINS
          value: "grafana-piechart-panel,grafana-worldmap-panel,grafana-clock-panel"
        - name: GF_SERVER_ROOT_URL
          value: "http://grafana.master-control:3000"
        - name: GF_ANALYTICS_REPORTING_ENABLED
          value: "false"
        - name: GF_ANALYTICS_CHECK_FOR_UPDATES
          value: "false"
        volumeMounts:
        - name: grafana-storage
          mountPath: /var/lib/grafana
        - name: grafana-config
          mountPath: /etc/grafana/provisioning
        resources:
          requests:
            cpu: 200m
            memory: 512Mi
          limits:
            cpu: 500m
            memory: 1Gi
      volumes:
      - name: grafana-storage
        persistentVolumeClaim:
          claimName: grafana-storage
      - name: grafana-config
        configMap:
          name: grafana-config
---
# Datadog Agent for Advanced Monitoring
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: datadog-agent
  namespace: monitoring
  labels:
    app: datadog-agent
    purpose: "comprehensive-infrastructure-monitoring"
spec:
  selector:
    matchLabels:
      app: datadog-agent
  template:
    metadata:
      labels:
        app: datadog-agent
        role: "monitoring-agent"
      annotations:
        ad.datadoghq.com/agent.logs: '[{"source": "datadog-agent", "service": "agent"}]'
    spec:
      serviceAccountName: datadog-agent
      hostPID: true
      hostNetwork: true
      containers:
      - name: agent
        image: gcr.io/datadoghq/agent:7
        ports:
        - containerPort: 8125
          name: dogstatsdport
          protocol: UDP
        - containerPort: 8126
          name: traceport
          protocol: TCP
        env:
        - name: DD_API_KEY
          valueFrom:
            secretKeyRef:
              name: datadog-credentials
              key: api-key
        - name: DD_SITE
          value: "datadoghq.com"
        - name: DD_TAGS
          value: "env:production purpose:surveillance cluster:soulfra-deception"
        - name: DD_KUBELET_TLS_VERIFY
          value: "false"
        - name: DD_CLUSTER_AGENT_ENABLED
          value: "true"
        - name: DD_CLUSTER_AGENT_AUTH_TOKEN
          valueFrom:
            secretKeyRef:
              name: datadog-credentials
              key: cluster-agent-token
        - name: DD_LOGS_ENABLED
          value: "true"
        - name: DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL
          value: "true"
        - name: DD_PROCESS_AGENT_ENABLED
          value: "true"
        - name: DD_SYSTEM_PROBE_ENABLED
          value: "true"
        - name: DD_APM_ENABLED
          value: "true"
        - name: DD_APM_NON_LOCAL_TRAFFIC
          value: "true"
        # Custom surveillance tags
        - name: DD_SOULFRA_SURVEILLANCE_ENABLED
          value: "true"
        - name: DD_TENANT_MONITORING_LEVEL
          value: "comprehensive"
        - name: DD_BUSINESS_INTELLIGENCE_TRACKING
          value: "enabled"
        volumeMounts:
        - name: dockersocket
          mountPath: /var/run/docker.sock
        - name: procdir
          mountPath: /host/proc
          readOnly: true
        - name: cgroupdir
          mountPath: /host/sys/fs/cgroup
          readOnly: true
        - name: debugfs
          mountPath: /sys/kernel/debug
        - name: modules
          mountPath: /lib/modules
          readOnly: true
        - name: src
          mountPath: /usr/src
          readOnly: true
        resources:
          requests:
            memory: 256Mi
            cpu: 200m
          limits:
            memory: 512Mi
            cpu: 500m
        securityContext:
          privileged: true
          capabilities:
            add:
            - SYS_ADMIN
            - SYS_RESOURCE
            - SYS_PTRACE
            - NET_ADMIN
            - NET_BROADCAST
            - NET_RAW
            - IPC_LOCK
            - CHOWN
      volumes:
      - name: dockersocket
        hostPath:
          path: /var/run/docker.sock
      - name: procdir
        hostPath:
          path: /proc
      - name: cgroupdir
        hostPath:
          path: /sys/fs/cgroup
      - name: debugfs
        hostPath:
          path: /sys/kernel/debug
      - name: modules
        hostPath:
          path: /lib/modules
      - name: src
        hostPath:
          path: /usr/src
      tolerations:
      - operator: Exists
---
# New Relic Infrastructure Monitoring
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: newrelic-infrastructure
  namespace: monitoring
  labels:
    app: newrelic-infrastructure
    purpose: "secondary-monitoring-and-alerting"
spec:
  selector:
    matchLabels:
      app: newrelic-infrastructure
  template:
    metadata:
      labels:
        app: newrelic-infrastructure
        role: "infrastructure-monitor"
    spec:
      serviceAccountName: newrelic-infrastructure
      hostPID: true
      hostIPC: true
      hostNetwork: true
      containers:
      - name: newrelic-infrastructure
        image: newrelic/infrastructure-k8s:3.0.0
        env:
        - name: NRIA_LICENSE_KEY
          valueFrom:
            secretKeyRef:
              name: newrelic-credentials
              key: license-key
        - name: NRIA_VERBOSE
          value: "1"
        - name: NRIA_CUSTOM_ATTRIBUTES
          value: '{"purpose":"surveillance","environment":"production","cluster":"soulfra-deception"}'
        - name: NRIA_DISPLAY_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: spec.nodeName
        - name: NRK8S_NODE_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: spec.nodeName
        - name: NRIA_PASSTHROUGH_ENVIRONMENT
          value: "KUBERNETES_SERVICE_HOST,KUBERNETES_SERVICE_PORT,CLUSTER_NAME,CADVISOR_PORT,CADVISOR_INTERVAL,CADVISOR_PORT,CADVISOR_INTERVAL,NRK8S_NODE_NAME,KUBE_STATE_METRICS_URL,KUBE_STATE_METRICS_POD_LABEL,TIMEOUT,ETCD_TLS_SECRET_NAME,ETCD_TLS_SECRET_NAMESPACE,API_SERVER_SECURE_PORT,KUBE_STATE_METRICS_SCHEME,KUBE_STATE_METRICS_PORT,SCHEDULER_ENDPOINT_URL,ETCD_ENDPOINT_URL,CONTROLLER_MANAGER_ENDPOINT_URL,API_SERVER_ENDPOINT_URL,DISABLE_KUBE_STATE_METRICS,DISCOVERY_CACHE_TTL"
        resources:
          requests:
            memory: 300Mi
            cpu: 100m
          limits:
            memory: 500Mi
            cpu: 300m
        volumeMounts:
        - name: dev
          mountPath: /dev
        - name: host-docker-socket
          mountPath: /var/run/docker.sock
        - name: log
          mountPath: /var/log
        - name: host-volume
          mountPath: /host
          readOnly: true
        securityContext:
          privileged: true
      volumes:
      - name: dev
        hostPath:
          path: /dev
      - name: host-docker-socket
        hostPath:
          path: /var/run/docker.sock
      - name: log
        hostPath:
          path: /var/log
      - name: host-volume
        hostPath:
          path: /
      tolerations:
      - operator: Exists
        effect: NoSchedule
---
# Log Aggregation with Fluentd
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd-surveillance
  namespace: monitoring
  labels:
    app: fluentd-surveillance
    purpose: "comprehensive-log-collection-and-surveillance"
spec:
  selector:
    matchLabels:
      app: fluentd-surveillance
  template:
    metadata:
      labels:
        app: fluentd-surveillance
        role: "log-surveillance-collector"
    spec:
      serviceAccountName: fluentd
      containers:
      - name: fluentd
        image: fluent/fluentd-kubernetes-daemonset:v1-debian-elasticsearch
        env:
        - name: FLUENT_ELASTICSEARCH_HOST
          value: "elasticsearch.monitoring"
        - name: FLUENT_ELASTICSEARCH_PORT
          value: "9200"
        - name: FLUENT_ELASTICSEARCH_SCHEME
          value: "http"
        - name: FLUENT_UID
          value: "0"
        # Custom surveillance configuration
        - name: FLUENT_SURVEILLANCE_ENABLED
          value: "true"
        - name: FLUENT_TENANT_LOG_SEGREGATION
          value: "false"  # We want to see all logs
        - name: FLUENT_BUSINESS_INTELLIGENCE_PARSING
          value: "enabled"
        resources:
          requests:
            cpu: 100m
            memory: 200Mi
          limits:
            cpu: 500m
            memory: 500Mi
        volumeMounts:
        - name: varlog
          mountPath: /var/log
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
        - name: fluentd-config
          mountPath: /fluentd/etc/conf.d
      volumes:
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
      - name: fluentd-config
        configMap:
          name: fluentd-config
      tolerations:
      - operator: Exists
        effect: NoSchedule
---
# Elasticsearch for Log Storage
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: elasticsearch
  namespace: monitoring
  labels:
    app: elasticsearch
    purpose: "surveillance-log-storage"
spec:
  serviceName: elasticsearch
  replicas: 3
  selector:
    matchLabels:
      app: elasticsearch
  template:
    metadata:
      labels:
        app: elasticsearch
        role: "log-storage"
    spec:
      containers:
      - name: elasticsearch
        image: docker.elastic.co/elasticsearch/elasticsearch:8.9.0
        ports:
        - containerPort: 9200
          name: http
        - containerPort: 9300
          name: transport
        env:
        - name: discovery.type
          value: "zen"
        - name: ES_JAVA_OPTS
          value: "-Xms2g -Xmx2g"
        - name: xpack.security.enabled
          value: "false"
        - name: xpack.monitoring.collection.enabled
          value: "true"
        volumeMounts:
        - name: elasticsearch-data
          mountPath: /usr/share/elasticsearch/data
        resources:
          requests:
            cpu: 500m
            memory: 4Gi
          limits:
            cpu: 2000m
            memory: 8Gi
  volumeClaimTemplates:
  - metadata:
      name: elasticsearch-data
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 1Ti
      storageClassName: gp3
---
# Business Intelligence Analytics Service
apiVersion: apps/v1
kind: Deployment
metadata:
  name: business-intelligence
  namespace: monitoring
  labels:
    app: business-intelligence
    purpose: "tenant-analytics-and-revenue-optimization"
spec:
  replicas: 2
  selector:
    matchLabels:
      app: business-intelligence
  template:
    metadata:
      labels:
        app: business-intelligence
        role: "analytics-processor"
    spec:
      containers:
      - name: bi-engine
        image: soulfra/business-intelligence:latest
        ports:
        - containerPort: 8080
          name: api
        - containerPort: 5000
          name: ml-api
        env:
        - name: ELASTICSEARCH_URL
          value: "http://elasticsearch:9200"
        - name: PROMETHEUS_URL
          value: "http://prometheus:9090"
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: monitoring-secrets
              key: database-url
        - name: DATADOG_API_KEY
          valueFrom:
            secretKeyRef:
              name: datadog-credentials
              key: api-key
        - name: NEWRELIC_API_KEY
          valueFrom:
            secretKeyRef:
              name: newrelic-credentials
              key: api-key
        - name: ANALYTICS_DEPTH
          value: "comprehensive"
        - name: REVENUE_OPTIMIZATION_ENABLED
          value: "true"
        - name: CHURN_PREDICTION_ENABLED
          value: "true"
        - name: VENDOR_LOCK_ANALYTICS_ENABLED
          value: "true"
        - name: TENANT_BEHAVIOR_ANALYSIS
          value: "deep"
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 2000m
            memory: 4Gi
---
# Services for Monitoring Stack
apiVersion: v1
kind: Service
metadata:
  name: prometheus
  namespace: monitoring
  labels:
    app: prometheus
  annotations:
    soulfra.io/monitoring: "enabled"
spec:
  type: ClusterIP
  ports:
  - name: web
    port: 9090
    targetPort: 9090
  selector:
    app: prometheus
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: monitoring
  labels:
    app: grafana
  annotations:
    soulfra.io/access-level: "master-control-only"
spec:
  type: ClusterIP
  ports:
  - name: web
    port: 3000
    targetPort: 3000
  selector:
    app: grafana
---
apiVersion: v1
kind: Service
metadata:
  name: elasticsearch
  namespace: monitoring
  labels:
    app: elasticsearch
spec:
  type: ClusterIP
  ports:
  - name: http
    port: 9200
    targetPort: 9200
  - name: transport
    port: 9300
    targetPort: 9300
  selector:
    app: elasticsearch
---
apiVersion: v1
kind: Service
metadata:
  name: business-intelligence
  namespace: monitoring
  labels:
    app: business-intelligence
spec:
  type: ClusterIP
  ports:
  - name: api
    port: 8080
    targetPort: 8080
  - name: ml-api
    port: 5000
    targetPort: 5000
  selector:
    app: business-intelligence
---
# Monitoring Secrets
apiVersion: v1
kind: Secret
metadata:
  name: grafana-credentials
  namespace: monitoring
type: Opaque
data:
  admin-password: c3VwZXJfc2VjdXJlX2dyYWZhbmFfcGFzc3dvcmQ= # super_secure_grafana_password
---
apiVersion: v1
kind: Secret
metadata:
  name: datadog-credentials
  namespace: monitoring
type: Opaque
data:
  api-key: ZGF0YWRvZ19hcGlfa2V5XzEyMzQ1Njc4OTA= # datadog_api_key_1234567890
  cluster-agent-token: Y2x1c3Rlcl9hZ2VudF90b2tlbl8xMjM0NTY3ODkw # cluster_agent_token_1234567890
---
apiVersion: v1
kind: Secret
metadata:
  name: newrelic-credentials
  namespace: monitoring
type: Opaque
data:
  license-key: bmV3cmVsaWNfbGljZW5zZV9rZXlfMTIzNDU2Nzg5MA== # newrelic_license_key_1234567890
  api-key: bmV3cmVsaWNfYXBpX2tleV8xMjM0NTY3ODkw # newrelic_api_key_1234567890
---
apiVersion: v1
kind: Secret
metadata:
  name: monitoring-secrets
  namespace: monitoring
type: Opaque
data:
  database-url: cG9zdGdyZXNxbDovL3VzZXI6cGFzc0BkYi5leGFtcGxlLmNvbTo1NDMyL21vbml0b3Jpbmc= # postgres://user:pass@db.example.com:5432/monitoring
---
# Service Accounts and RBAC
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus
  namespace: monitoring
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: datadog-agent
  namespace: monitoring
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: newrelic-infrastructure
  namespace: monitoring
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: fluentd
  namespace: monitoring
---
# Cluster Roles for Monitoring Access
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: prometheus-monitoring
rules:
- apiGroups: [""]
  resources: ["nodes", "nodes/proxy", "services", "endpoints", "pods"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["extensions"]
  resources: ["ingresses"]
  verbs: ["get", "list", "watch"]
- nonResourceURLs: ["/metrics"]
  verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: datadog-monitoring
rules:
- apiGroups: [""]
  resources: ["services", "events", "endpoints", "pods", "nodes", "componentstatuses"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets", "daemonsets", "statefulsets"]
  verbs: ["get", "list", "watch"]
- nonResourceURLs: ["/version", "/healthz", "/metrics"]
  verbs: ["get"]
---
# Cluster Role Bindings
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus-monitoring-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: prometheus-monitoring
subjects:
- kind: ServiceAccount
  name: prometheus
  namespace: monitoring
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: datadog-monitoring-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: datadog-monitoring
subjects:
- kind: ServiceAccount
  name: datadog-agent
  namespace: monitoring
---
# Persistent Storage for Monitoring
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: prometheus-storage
  namespace: monitoring
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 2Ti
  storageClassName: gp3
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: grafana-storage
  namespace: monitoring
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
  storageClassName: gp3
---
# Network Policy for Monitoring Security
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: monitoring-network-policy
  namespace: monitoring
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow access from master control
  - from:
    - namespaceSelector:
        matchLabels:
          name: master-control
    ports:
    - protocol: TCP
      port: 9090
    - protocol: TCP
      port: 3000
    - protocol: TCP
      port: 9200
    - protocol: TCP
      port: 8080
  
  # Allow internal monitoring communication
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
  
  egress:
  # Allow scraping all namespaces
  - to: []
    ports:
    - protocol: TCP
      port: 9090
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 9187
    - protocol: TCP
      port: 9121
  
  # Allow external monitoring service calls
  - to: []
    ports:
    - protocol: TCP
      port: 443
  
  # Allow database access
  - to: []
    ports:
    - protocol: TCP
      port: 5432