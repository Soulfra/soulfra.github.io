<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CringeProof - Voice Memos That Age</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: white;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 40px;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .tagline {
      font-size: 1.2rem;
      opacity: 0.9;
    }

    .upload-area {
      background: rgba(255, 255, 255, 0.1);
      border: 2px dashed rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      padding: 60px 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 40px;
    }

    .upload-area:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .upload-area.dragover {
      background: rgba(255, 255, 255, 0.2);
      border-color: white;
    }

    .upload-icon {
      font-size: 4rem;
      margin-bottom: 20px;
    }

    .upload-text {
      font-size: 1.2rem;
      margin-bottom: 10px;
    }

    .upload-subtext {
      font-size: 0.9rem;
      opacity: 0.7;
    }

    input[type="file"] {
      display: none;
    }

    .memo-list {
      margin-top: 40px;
    }

    .memo-item {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }

    .memo-item:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
    }

    .memo-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .memo-title {
      font-size: 1.1rem;
      font-weight: bold;
    }

    .memo-date {
      font-size: 0.85rem;
      opacity: 0.7;
    }

    .memo-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-block;
    }

    .btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .btn-primary {
      background: rgba(59, 130, 246, 0.6);
    }

    .btn-primary:hover {
      background: rgba(59, 130, 246, 0.8);
    }

    .qr-card {
      background: white;
      color: #333;
      border-radius: 12px;
      padding: 30px;
      margin-top: 20px;
      text-align: center;
      display: none;
    }

    .qr-card.active {
      display: block;
    }

    .qr-code {
      width: 200px;
      height: 200px;
      margin: 20px auto;
    }

    .share-url {
      background: #f3f4f6;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      word-break: break-all;
      font-family: monospace;
      font-size: 0.9rem;
    }

    .loading {
      text-align: center;
      padding: 40px;
      display: none;
    }

    .loading.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üé§ CringeProof</h1>
      <p class="tagline">Voice memos that age. Will your takes hold up?</p>
    </header>

    <!-- Upload Area -->
    <div class="upload-area" id="uploadArea">
      <div class="upload-icon">üìÅ</div>
      <div class="upload-text">Drop voice memo here or click to upload</div>
      <div class="upload-subtext">From iPhone Voice Memos app (.m4a, .mp3, .wav)</div>
      <input type="file" id="fileInput" accept="audio/*">
    </div>

    <!-- Loading State -->
    <div class="loading" id="loading">
      <div>‚è≥ Processing voice memo...</div>
    </div>

    <!-- QR Card (Hidden until generated) -->
    <div class="qr-card" id="qrCard">
      <h2>üì§ Your Voice Memo</h2>
      <div id="qrCode" class="qr-code"></div>
      <p>Scan QR code to listen</p>
      <div class="share-url" id="shareUrl"></div>
      <div style="margin-top: 20px;">
        <button class="btn btn-primary" onclick="downloadCard()">üíæ Save as Image</button>
        <button class="btn" onclick="copyUrl()">üìã Copy URL</button>
      </div>
    </div>

    <!-- Memo List -->
    <div class="memo-list" id="memoList">
      <h2>Your Voice Memos</h2>
      <div id="memos"></div>
    </div>
  </div>

  <!-- QR Code Library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <script>
    const API_URL = window.location.hostname === 'localhost'
      ? 'http://localhost:3002'
      : 'https://api.soulfra.com';

    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const loading = document.getElementById('loading');
    const qrCard = document.getElementById('qrCard');
    const qrCode = document.getElementById('qrCode');
    const shareUrl = document.getElementById('shareUrl');
    const memoList = document.getElementById('memos');

    // Click to upload
    uploadArea.addEventListener('click', () => fileInput.click());

    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');

      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
      }
    });

    // Handle file upload
    async function handleFile(file) {
      if (!file.type.startsWith('audio/')) {
        alert('Please upload an audio file');
        return;
      }

      loading.classList.add('active');
      qrCard.classList.remove('active');

      try {
        // Create FormData
        const formData = new FormData();
        formData.append('audio', file);
        formData.append('title', file.name.replace(/\.[^/.]+$/, '')); // Remove extension

        // Upload to API
        const response = await fetch(`${API_URL}/api/cringeproof/voice/upload`, {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Upload failed');
        }

        // Show QR card
        const memoUrl = `${window.location.origin}/listen/${data.id}`;
        shareUrl.textContent = memoUrl;

        // Generate QR code
        qrCode.innerHTML = '';
        QRCode.toCanvas(qrCode, memoUrl, {
          width: 200,
          margin: 2,
          color: {
            dark: '#333',
            light: '#fff'
          }
        }, (error) => {
          if (error) console.error(error);
        });

        qrCard.classList.add('active');

        // Reload memo list
        loadMemos();

      } catch (error) {
        console.error('Upload error:', error);
        alert(`Upload failed: ${error.message}`);
      } finally {
        loading.classList.remove('active');
      }
    }

    // Copy URL to clipboard
    function copyUrl() {
      const url = shareUrl.textContent;
      navigator.clipboard.writeText(url);
      alert('URL copied to clipboard!');
    }

    // Download QR card as image
    function downloadCard() {
      // Create canvas with card design
      const canvas = document.createElement('canvas');
      canvas.width = 600;
      canvas.height = 800;
      const ctx = canvas.getContext('2d');

      // Background
      ctx.fillStyle = '#667eea';
      ctx.fillRect(0, 0, 600, 800);

      // Title
      ctx.fillStyle = 'white';
      ctx.font = 'bold 48px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('CringeProof', 300, 100);

      // Subtitle
      ctx.font = '24px sans-serif';
      ctx.fillText('Voice Memo', 300, 150);

      // QR code (get from canvas)
      const qrCanvas = qrCode.querySelector('canvas');
      if (qrCanvas) {
        ctx.drawImage(qrCanvas, 150, 200, 300, 300);
      }

      // URL
      ctx.font = '18px monospace';
      const url = shareUrl.textContent;
      const urlLines = splitText(url, 40);
      urlLines.forEach((line, i) => {
        ctx.fillText(line, 300, 550 + (i * 30));
      });

      // Instructions
      ctx.font = '20px sans-serif';
      ctx.fillText('Scan to listen', 300, 700);

      // Download
      canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'cringeproof-memo.png';
        a.click();
        URL.revokeObjectURL(url);
      });
    }

    // Helper to split text
    function splitText(text, maxLength) {
      const lines = [];
      for (let i = 0; i < text.length; i += maxLength) {
        lines.push(text.substring(i, i + maxLength));
      }
      return lines;
    }

    // Load user's memos
    async function loadMemos() {
      try {
        const response = await fetch(`${API_URL}/api/cringeproof/voice/list`);
        const memos = await response.json();

        if (memos.length === 0) {
          memoList.innerHTML = '<p style="opacity: 0.7;">No voice memos yet. Upload one above!</p>';
          return;
        }

        memoList.innerHTML = memos.map(memo => `
          <div class="memo-item">
            <div class="memo-header">
              <div class="memo-title">${memo.title}</div>
              <div class="memo-date">${new Date(memo.created_at).toLocaleDateString()}</div>
            </div>
            <audio controls style="width: 100%;">
              <source src="${memo.audio_url}" type="audio/mpeg">
            </audio>
            <div class="memo-actions">
              <a href="/listen/${memo.id}" class="btn" target="_blank">üîó Share</a>
              <button class="btn" onclick="showQR('${memo.id}', '${memo.title}')">üì± QR Code</button>
              <button class="btn" onclick="exportMemo('${memo.id}')">üíæ Export</button>
            </div>
          </div>
        `).join('');

      } catch (error) {
        console.error('Failed to load memos:', error);
      }
    }

    // Show QR for existing memo
    function showQR(memoId, title) {
      const url = `${window.location.origin}/listen/${memoId}`;
      shareUrl.textContent = url;

      qrCode.innerHTML = '';
      QRCode.toCanvas(qrCode, url, {
        width: 200,
        margin: 2
      });

      qrCard.classList.add('active');
      qrCard.scrollIntoView({ behavior: 'smooth' });
    }

    // Export memo
    function exportMemo(memoId) {
      window.location.href = `${API_URL}/api/cringeproof/voice/${memoId}/export`;
    }

    // Load memos on page load
    loadMemos();
  </script>
</body>
</html>
