<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Search & Earn VIBES - DeathToData</title>
  <meta name="description" content="Privacy-first search where you earn 0.2 VIBES per query. No tracking, no surveillance."/>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json"/>
  <link rel="icon" href="favicon.ico" type="image/x-icon"/>
  <link rel="apple-touch-icon" href="apple-touch-icon.png"/>
  <meta name="theme-color" content="#fb0044"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

  <!-- Shared Styles -->
  <link rel="stylesheet" href="assets/deathtodata.css"/>

  <style>
    /* Page-specific styles for search.html */
    .search-container {
      max-width: 900px;
      margin: 60px auto;
      padding: 0 20px;
    }

    .search-box-wrapper {
      position: relative;
      margin-bottom: 20px;
    }

    .search-box {
      width: 100%;
      padding: 18px 120px 18px 24px;
      font-size: 18px;
    }

    .search-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: #fb0044;
      border: none;
      color: #000;
      padding: 10px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .search-btn:hover {
      background: #ff1a5e;
      box-shadow: 0 0 16px rgba(251, 0, 68, 0.7);
    }

    .earn-notice {
      text-align: center;
      color: #888;
      font-size: 14px;
      margin-top: 12px;
    }

    /* VIBES notification */
    .vibes-notification {
      position: fixed;
      top: 100px;
      right: 40px;
      background: rgba(251, 0, 68, 0.2);
      border: 1px solid #fb0044;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(251, 0, 68, 0.5);
      transform: translateX(400px);
      transition: transform 0.3s ease;
      z-index: 1000;
    }

    .vibes-notification.show {
      transform: translateX(0);
    }

    .vibes-notification .amount {
      font-size: 24px;
      color: #fb0044;
      font-weight: bold;
    }

    /* Results */
    .results-container {
      margin-top: 40px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #888;
      font-size: 18px;
      display: none;
    }

    .loading.active {
      display: block;
    }

    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .result-item {
      background: rgba(20, 20, 20, 0.8);
      border: 1px solid rgba(251, 0, 68, 0.2);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
      transition: all 0.3s ease;
    }

    .result-item:hover {
      border-color: rgba(251, 0, 68, 0.5);
      box-shadow: 0 0 16px rgba(251, 0, 68, 0.3);
    }

    .result-title {
      font-size: 18px;
      color: #fb0044;
      margin-bottom: 8px;
      font-weight: bold;
    }

    .result-title a {
      color: #fb0044;
      text-decoration: none;
    }

    .result-title a:hover {
      text-decoration: underline;
    }

    .result-url {
      color: #666;
      font-size: 12px;
      margin-bottom: 8px;
      word-break: break-all;
    }

    .result-snippet {
      color: #ccc;
      line-height: 1.6;
      font-size: 14px;
    }

    .no-results {
      text-align: center;
      padding: 60px 20px;
      color: #888;
    }

    .no-results h3 {
      color: #fb0044;
      font-size: 24px;
      margin-bottom: 12px;
    }

    @media (max-width: 768px) {
      .search-box {
        padding-right: 100px;
        font-size: 16px;
      }

      .search-btn {
        padding: 8px 16px;
        font-size: 12px;
      }

      .vibes-notification {
        right: 20px;
        left: 20px;
      }
    }
  </style>
</head>
<body>

  <!-- Matrix background -->
  <canvas id="canvas"></canvas>

  <!-- Header -->
  <header>
    <a href="index.html" class="logo-link">
      <img src="logo.jpeg" alt="DeathToData" class="logo-img">
      <span class="logo-text">DEATH2DATA</span>
    </a>
    <div class="vibes-display">
      <div class="vibes-balance">
        <strong id="vibesBalance">0.0</strong> VIBES
        <span class="usd-value">($<span id="usdValue">0.00</span>)</span>
      </div>
      <a href="dashboard.html" class="nav-link">Dashboard</a>
    </div>
  </header>

  <!-- Search container -->
  <div class="search-container">
    <div class="search-box-wrapper">
      <input
        type="text"
        class="search-box"
        id="searchInput"
        placeholder="Search and earn VIBES..."
        autofocus
        autocomplete="off"
      >
      <button class="search-btn" id="searchBtn">SEARCH</button>
    </div>
    <p class="earn-notice">
      Earn <strong>+0.2 VIBES</strong> per search · Privacy-first · No tracking
    </p>

    <!-- Loading -->
    <div class="loading" id="loading">Searching</div>

    <!-- Results -->
    <div class="results-container" id="results"></div>
  </div>

  <!-- VIBES notification -->
  <div class="vibes-notification" id="vibesNotification">
    <div class="amount">+0.2 VIBES</div>
    <div style="font-size: 14px; color: #ccc; margin-top: 4px;">Earned from search</div>
  </div>

  <!-- Footer -->
  <footer>
    <p><strong>Deal with it, Google.</strong></p>
    <p>&copy; 2026 DeathToData. Every search is a vote against surveillance capitalism.</p>
  </footer>

  <!-- Shared JavaScript -->
  <script src="assets/deathtodata.js"></script>

  <!-- Page-specific JavaScript -->
  <script>
    // Search handling
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const results = document.getElementById('results');
    const loading = document.getElementById('loading');

    // Get query from URL
    const urlParams = new URLSearchParams(window.location.search);
    const initialQuery = urlParams.get('q');
    if (initialQuery) {
      searchInput.value = initialQuery;
      performSearch(initialQuery);
    }

    // Search button
    searchBtn.addEventListener('click', () => {
      const query = searchInput.value.trim();
      if (query) {
        performSearch(query);
        updateURL(query);
      }
    });

    // Enter key
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const query = searchInput.value.trim();
        if (query) {
          performSearch(query);
          updateURL(query);
        }
      }
    });

    function updateURL(query) {
      const url = new URL(window.location);
      url.searchParams.set('q', query);
      window.history.pushState({}, '', url);
    }

    async function performSearch(query) {
      loading.classList.add('active');
      results.innerHTML = '';
      searchBtn.disabled = true;

      const startTime = Date.now();

      try {
        const response = await fetch(`${API_URL}/api/search?q=${encodeURIComponent(query)}`);

        if (!response.ok) {
          throw new Error('Search failed');
        }

        const data = await response.json();
        const searchTime = ((Date.now() - startTime) / 1000).toFixed(2);

        loading.classList.remove('active');
        searchBtn.disabled = false;

        // Award VIBES
        awardVibes(0.2);

        if (data.results && data.results.length > 0) {
          displayResults(data.results, searchTime);
        } else {
          results.innerHTML = `
            <div class="no-results">
              <h3>No results found</h3>
              <p>Try different keywords or check your spelling.</p>
            </div>
          `;
        }

      } catch (error) {
        loading.classList.remove('active');
        searchBtn.disabled = false;
        results.innerHTML = `
          <div class="no-results">
            <h3>Search Error</h3>
            <p>Could not connect to search service.</p>
            <p style="color: #fb0044; margin-top: 12px; font-size: 12px;">
              ${error.message}
            </p>
            <p style="margin-top: 12px; font-size: 12px;">
              Make sure backend is running: <code>./start-deathtodata-simple.sh</code>
            </p>
          </div>
        `;
      }
    }

    function displayResults(searchResults, searchTime) {
      const header = `<p style="text-align: center; color: #888; margin-bottom: 20px; font-size: 14px;">About ${searchResults.length} results (${searchTime}s)</p>`;
      const resultsHTML = searchResults.map(result => `
        <div class="result-item">
          <div class="result-title">
            <a href="${escapeHtml(result.url)}" target="_blank" rel="noopener noreferrer">
              ${escapeHtml(result.title || 'Untitled')}
            </a>
          </div>
          <div class="result-url">${escapeHtml(result.url)}</div>
          <div class="result-snippet">${escapeHtml(result.snippet || 'No description available.')}</div>
        </div>
      `).join('');

      results.innerHTML = header + resultsHTML;
    }
  </script>

</body>
</html>
